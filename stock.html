<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Stock de Bebidas - Salón de Eventos MYM</title>
  <link rel="icon" href="https://mymeventos.github.io/bebidas/mi-icono.png" type="image/png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />
  <style>
    body { background-color: #f0f2f5; padding: 30px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: #333; }
    .container { max-width: 900px; background: #fff; padding: 35px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.1); }
    .card { border: none; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); }
    .card-header { background-color: #007bff; color: white; font-weight: bold; border-radius: 10px 10px 0 0; padding: 15px 20px; font-size: 1.2rem; }
    .stock-item { background: #e6f2ff; border: 1px solid #cce0ff; border-radius: 8px; padding: 15px; text-align: center; min-width: 130px; flex: 1 1 150px; transition: transform 0.2s; }
    .stock-item:hover { transform: translateY(-3px); }
    .stock-item strong { display: block; font-size: 1.1em; color: #0056b3; }
    .stock-item span { font-size: 1.5em; font-weight: bold; color: #007bff; }
    #authContainer { max-width: 400px; margin: 50px auto; padding: 30px; background: #fff; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.1); }
    .logo-container { text-align: center; margin-bottom: 20px; }
    .logo-container img { max-width: 250px; height: auto; }
  </style>
</head>
<body>

<div id="appContent" style="display: none;">
  <div class="container">
    <div class="logo-container">
      <img src="https://mymeventos.github.io/bebidas/logo.png" alt="Logo Salón de Eventos MYM">
    </div>
    <h1 class="text-center mb-4"><i class="fas fa-warehouse"></i> Stock de Bebidas</h1>
    <p class="text-muted text-center" id="currentUserIdDisplay"></p>
    <div class="text-center mb-3">
      <button id="logoutBtn" class="btn btn-outline-danger btn-sm"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</button>
    </div>

    <div class="card">
      <div class="card-header">
        <i class="fas fa-chart-bar"></i> Stock Actual
        <button class="btn btn-sm btn-light float-end" id="btnActualizarStock"><i class="fas fa-sync-alt"></i></button>
      </div>
      <div class="card-body d-flex flex-wrap gap-3 justify-content-center" id="stockContainer">
        </div>
    </div>
  </div>
</div>

<div id="authContainer">
  <div class="logo-container">
      <img src="https://mymeventos.github.io/bebidas/logo.png" alt="Logo Salón de Eventos MYM">
  </div>
  <h2 class="text-center mb-4">Acceso al Inventario</h2>
  <div class="mb-3">
    <label for="emailInput" class="form-label">Email</label>
    <input type="email" class="form-control" id="emailInput" placeholder="tu@email.com" required>
  </div>
  <div class="mb-3">
    <label for="passwordInput" class="form-label">Contraseña</label>
    <input type="password" class="form-control" id="passwordInput" placeholder="********" required>
  </div>
  <div class="d-grid gap-2">
    <button id="signInBtn" class="btn btn-primary">Iniciar Sesión</button>
    <button id="signUpBtn" class="btn btn-secondary">Registrarse</button>
  </div>
  <div id="authAlerta" class="alert d-none mt-3"></div>
</div>


<script type="module">
  // Importaciones de Firebase SDK
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, collection, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // Configuración de Firebase (tomada de tu archivo original)
  const firebaseConfig = {
    apiKey: "AIzaSyCfYVuYB0azsjXohRlpt47rvIJWX31YnVg",
    authDomain: "bebidas-f2e09.firebaseapp.com",
    projectId: "bebidas-f2e09",
    storageBucket: "bebidas-f2e09.firebasestorage.app",
    messagingSenderId: "3759804003",
    appId: "1:3759804003:web:a6fc813d925c681c597256",
    measurementId: "G-JZQG7XKRJC"
  };

  const appId = 'default-app-id';
  
  // Lista de bebidas actualizadas
  const bebidas = ["Coca","Coca Zero","Sprite","Sprite Zero","Fanta","Fanta Zero","Agua","Agua Tónica","Soda","Vino Tinto","Vino Blanco","Champagne","Sidra","Cerveza","Cerveza sin Alcohol","Rutini","Trumpeter","Nicasia","Nicasia Viognier","Tardio","Sidra sin alcohol","Anana fizz","Gancia","Ron","Ron especial","Carpano rosso","Campari","Vodka","Aperol","Piña colada","Licor de Frutilla","Licor de chocolate","Licor de menta","Blue Curacao","Gin","Fernet", "Whisky","Minerva","Jugo de naranja","Pulpa de frutilla","Pulpa de melon"];
  
  const bebidasAdulto = ["Vino Tinto", "Vino Blanco", "Champagne", "Sidra", "Cerveza", "Cerveza sin Alcohol", "Rutini", "Trumpeter", "Nicasia", "Nicasia Viognier", "Tardio", "Sidra sin alcohol", "Anana fizz", "Gancia", "Ron", "Ron especial", "Carpano rosso", "Campari", "Vodka", "Aperol", "Piña colada", "Licor de Frutilla", "Licor de chocolate", "Licor de menta", "Blue Curacao", "Gin", "Fernet", "Whisky"];


  // Referencias a elementos del DOM
  const appContent = document.getElementById("appContent");
  const authContainer = document.getElementById("authContainer");
  const stockContainer = document.getElementById("stockContainer");
  const currentUserIdDisplay = document.getElementById("currentUserIdDisplay");
  const logoutBtn = document.getElementById("logoutBtn");
  const btnActualizarStock = document.getElementById("btnActualizarStock");
  const emailInput = document.getElementById("emailInput");
  const passwordInput = document.getElementById("passwordInput");
  const signInBtn = document.getElementById("signInBtn");
  const signUpBtn = document.getElementById("signUpBtn");
  const authAlerta = document.getElementById("authAlerta");

  // Inicialización de Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  
  let userId = null;
  let unsubscribeStock = null; // Para guardar la función que detiene el listener de stock

  /**
   * Muestra u oculta una alerta.
   */
  function mostrarAlerta(msg, tipo, targetAlerta = authAlerta) {
    targetAlerta.textContent = msg;
    targetAlerta.className = `alert alert-${tipo}`;
    targetAlerta.classList.remove("d-none");
    setTimeout(() => targetAlerta.classList.add("d-none"), 4000);
  }

  /**
   * Carga y muestra el stock actual de bebidas en tiempo real.
   */
  function cargarStock() {
    if (!userId) return;

    stockContainer.innerHTML = "<p class='text-muted'>Cargando stock...</p>";
    const movimientosPath = `artifacts/${appId}/users/${userId}/movimientos`;
    const q = query(collection(db, movimientosPath));

    // Si ya hay un listener activo, lo detenemos antes de crear uno nuevo.
    if (unsubscribeStock) {
      unsubscribeStock();
    }

    unsubscribeStock = onSnapshot(q, (snapshot) => {
      const stock = {};
      bebidas.forEach(b => { stock[b] = 0; }); // Inicializa todas las bebidas en 0

      snapshot.forEach(doc => {
        const data = doc.data();
        if (data.bebida && !isNaN(data.cantidad)) {
          if (data.tipo === "compra") {
            stock[data.bebida] += Number(data.cantidad);
          } else if (data.tipo === "consumo" || data.tipo === "merma") {
            stock[data.bebida] -= Number(data.cantidad);
          }
        }
      });

      stockContainer.innerHTML = "";
      if (Object.keys(stock).length === 0) {
        stockContainer.innerHTML = "<p class='text-center text-info'>No hay stock registrado.</p>";
        return;
      }

      bebidas.forEach(b => {
        const cantidad = stock[b] || 0;
        stockContainer.innerHTML += `<div class="stock-item"><strong>${b}</strong><span>${cantidad}</span></div>`;
      });
    }, (error) => {
      console.error("Error al cargar stock:", error);
      stockContainer.innerHTML = `<p class='text-danger'>Error al cargar stock: ${error.message}</p>`;
    });
  }

  // --- MANEJO DE AUTENTICACIÓN ---
  
  onAuthStateChanged(auth, (user) => {
    if (user) {
      // Usuario ha iniciado sesión
      userId = user.uid;
      currentUserIdDisplay.textContent = `Usuario: ${user.email}`;
      authContainer.style.display = 'none';
      appContent.style.display = 'block';
      cargarStock();
    } else {
      // Usuario ha cerrado sesión
      userId = null;
      if (unsubscribeStock) unsubscribeStock(); // Detiene el listener de stock al cerrar sesión
      authContainer.style.display = 'block';
      appContent.style.display = 'none';
    }
  });

  signInBtn.addEventListener('click', async () => {
    try {
      await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
    } catch (error) {
      mostrarAlerta(error.message, "danger");
    }
  });

  signUpBtn.addEventListener('click', async () => {
    try {
      await createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
    } catch (error) {
      mostrarAlerta(error.message, "danger");
    }
  });
  
  logoutBtn.addEventListener('click', () => {
    signOut(auth);
  });

  btnActualizarStock.addEventListener('click', cargarStock);

</script>
</body>
</html>