<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Control de Movimientos de Inventario</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />
  <style>
    body { background-color: #f0f2f5; padding: 30px; font-family: 'Segoe UI', Tahoma; color: #333; }
    .container { background: #fff; padding: 35px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.1); }
    .card { border: none; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); margin-bottom: 30px; }
    .card-header { background-color: #007bff; color: white; font-weight: bold; border-radius: 10px 10px 0 0; padding: 15px 20px; font-size: 1.2rem; }
    .table thead th { background-color: #495057; color: white; }
    .table tbody tr:hover { background-color: #f5f5f5; cursor: pointer; } /* Indica que las filas son clicables */
    .table-responsive { overflow-x: auto; }
    .btn-action { margin: 2px; }
    .modal-header { background-color: #007bff; color: white; border-radius: 8px 8px 0 0; }
    .modal-footer { justify-content: space-between; }
    #deleteSelectedBtn { display: none; margin-top: 15px; } /* Oculto por defecto */
    #authContainer {
      max-width: 400px;
      margin: 50px auto;
      padding: 30px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
<div id="appContent" style="display: none;">
  <div class="container">
    <h1 class="text-center mb-4"><i class="fas fa-clipboard-list"></i> Control de Movimientos</h1>
    <p class="text-muted text-center" id="currentUserIdDisplay">Cargando ID de usuario...</p>
    <div class="text-center mb-3">
      <button id="logoutBtn" class="btn btn-outline-danger btn-sm"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</button>
    </div>

    <div class="card">
      <div class="card-header"><i class="fas fa-history"></i> Historial de Movimientos</div>
      <div class="card-body">
        <div id="movimientosTableContainer" class="table-responsive">
          <p class="text-muted text-center">Cargando movimientos...</p>
        </div>
        <button type="button" class="btn btn-danger mt-3" id="deleteSelectedBtn"><i class="fas fa-trash"></i> Eliminar Seleccionados</button>
        <div id="alerta" class="alert d-none mt-3"></div>
      </div>
    </div>
  </div>
</div>

<div id="authContainer">
  <h2 class="text-center mb-4">Iniciar Sesión / Registrarse</h2>
  <div class="mb-3">
    <label for="emailInput" class="form-label">Email</label>
    <input type="email" class="form-control" id="emailInput" placeholder="tu@email.com" required>
  </div>
  <div class="mb-3">
    <label for="passwordInput" class="form-label">Contraseña</label>
    <input type="password" class="form-control" id="passwordInput" placeholder="********" required>
  </div>
  <div class="d-grid gap-2">
    <button id="signInBtn" class="btn btn-primary">Iniciar Sesión</button>
    <button id="signUpBtn" class="btn btn-secondary">Registrarse</button>
  </div>
  <div id="authAlerta" class="alert d-none mt-3"></div>
</div>

<!-- Modal de Edición/Eliminación -->
<div class="modal fade" id="editMovementModal" tabindex="-1" aria-labelledby="editMovementModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editMovementModalLabel">Editar Movimiento</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editMovementForm">
          <input type="hidden" id="editDocId">
          <div class="row g-3 mb-3">
            <div class="col-md-4"><label class="form-label">Fecha</label><input type="date" class="form-control" id="editFecha" required /></div>
            <div class="col-md-4"><label class="form-label">Tipo</label><select class="form-select" id="editTipo"><option value="compra">Compra</option><option value="consumo">Consumo</option><option value="merma">Merma</option></select></div>
            <div class="col-md-4"><label class="form-label">Bebida</label><select class="form-select" id="editBebida" required></select></div>
          </div>
          <div class="row g-3 mb-3">
            <div class="col-md-4"><label class="form-label">Cantidad</label><input type="number" class="form-control" id="editCantidad" min="0" required /></div>
            <div class="col-md-4"><label class="form-label">Precio</label><input type="number" class="form-control" id="editPrecio" min="0" step="0.01" /></div>
            <div class="col-md-4"><label class="form-label">Evento</label><input type="text" class="form-control" id="editEvento" /></div>
          </div>
          <div class="mb-3"><label class="form-label">Usuario</label><input type="text" class="form-control" id="editUsuario" /></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" id="btnDeleteMovement"><i class="fas fa-trash"></i> Eliminar</button>
        <div>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          <button type="button" class="btn btn-primary" id="btnSaveChanges"><i class="fas fa-save"></i> Guardar Cambios</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script type="module">
  // Importaciones de Firebase SDK
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, collection, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc, serverTimestamp, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // Variables globales proporcionadas por el entorno de Canvas
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
  // Configuración de Firebase: Usamos directamente la configuración de tu proyecto
  const firebaseConfig = {
    apiKey: "AIzaSyCfYVuYB0azsjXohRlpt47rvIJWX31YnVg",
    authDomain: "bebidas-f2e09.firebaseapp.com",
    projectId: "bebidas-f2e09",
    storageBucket: "bebidas-f2e09.firebasestorage.app",
    messagingSenderId: "3759804003",
    appId: "1:3759804003:web:a6fc813d925c681c597256",
    measurementId: "G-JZQG7XKRJC"
  };
  const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

  // Inicialización de Firebase
  let app;
  let db;
  let auth;
  let userId = null; // Para almacenar el ID del usuario autenticado
  let isAuthReady = false; // Bandera para saber cuándo la autenticación está lista

  // Lista de bebidas disponibles (debe ser la misma que en las otras apps)
  const bebidas = ["Coca","Coca Zero","Sprite","Sprite Zero","Fanta","Fanta Zero","Agua","Agua Tónica","Soda","Vino Tinto","Vino Blanco","Champagne","Sidra","Cerveza","Cerveza sin Alcohol"];

  // Referencias a elementos del DOM de la aplicación principal
  const appContent = document.getElementById("appContent");
  const movimientosTableContainer = document.getElementById("movimientosTableContainer");
  const alerta = document.getElementById("alerta");
  const currentUserIdDisplay = document.getElementById("currentUserIdDisplay"); 
  const deleteSelectedBtn = document.getElementById("deleteSelectedBtn"); 
  const logoutBtn = document.getElementById("logoutBtn");

  // Referencias a elementos del DOM de autenticación
  const authContainer = document.getElementById("authContainer");
  const emailInput = document.getElementById("emailInput");
  const passwordInput = document.getElementById("passwordInput");
  const signInBtn = document.getElementById("signInBtn");
  const signUpBtn = document.getElementById("signUpBtn");
  const authAlerta = document.getElementById("authAlerta");

  // Referencias a elementos del modal de edición
  const editMovementModal = new bootstrap.Modal(document.getElementById('editMovementModal'));
  const editDocId = document.getElementById('editDocId');
  const editFecha = document.getElementById('editFecha');
  const editTipo = document.getElementById('editTipo');
  const editBebida = document.getElementById('editBebida');
  const editCantidad = document.getElementById('editCantidad');
  const editPrecio = document.getElementById('editPrecio');
  const editEvento = document.getElementById('editEvento');
  const editUsuario = document.getElementById('editUsuario');
  const btnSaveChanges = document.getElementById('btnSaveChanges');
  const btnDeleteMovement = document.getElementById('btnDeleteMovement');

  /**
   * Muestra una alerta temporal.
   * @param {string} msg - El mensaje a mostrar.
   * @param {string} tipo - El tipo de alerta (ej. "success", "warning", "danger").
   * @param {HTMLElement} targetAlerta - El elemento de alerta donde mostrar el mensaje.
   */
  function mostrarAlerta(msg, tipo, targetAlerta = alerta) {
    targetAlerta.textContent = msg;
    targetAlerta.className = `alert alert-${tipo} mt-3`;
    targetAlerta.classList.remove("d-none");
    setTimeout(() => targetAlerta.classList.add("d-none"), 4000);
  }

  /**
   * Inicializa Firebase y configura el listener de autenticación.
   */
  async function initFirebase() {
    console.log("Iniciando Firebase...");
    try {
      app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      auth = getAuth(app);

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          userId = user.uid;
          isAuthReady = true;
          console.log("Usuario autenticado:", userId);
          currentUserIdDisplay.textContent = `ID de Usuario: ${userId}`; 
          appContent.style.display = 'block'; // Muestra el contenido de la aplicación
          authContainer.style.display = 'none'; // Oculta el formulario de autenticación
          setupRealtimeListener(); // Configura el listener en tiempo real para los movimientos
          populateBebidaSelect(editBebida); // Llena el select de bebidas en el modal
        } else {
          userId = null;
          isAuthReady = false;
          console.log("No hay usuario autenticado.");
          currentUserIdDisplay.textContent = `ID de Usuario: No autenticado`;
          appContent.style.display = 'none'; // Oculta el contenido de la aplicación
          authContainer.style.display = 'block'; // Muestra el formulario de autenticación
        }
      });
    } catch (error) {
      console.error("Error al inicializar Firebase:", error);
      mostrarAlerta("Error al inicializar la aplicación. Verifique la configuración.", "danger", authAlerta);
      isAuthReady = false;
    }
  }

  /**
   * Maneja el registro de un nuevo usuario con email y contraseña.
   */
  signUpBtn.addEventListener('click', async () => {
    const email = emailInput.value;
    const password = passwordInput.value;

    if (!email || !password) {
      mostrarAlerta("Por favor, ingrese email y contraseña.", "warning", authAlerta);
      return;
    }

    try {
      await createUserWithEmailAndPassword(auth, email, password);
      mostrarAlerta("¡Registro exitoso! Sesión iniciada.", "success", authAlerta);
      // onAuthStateChanged manejará la visualización de la app
    } catch (error) {
      console.error("Error al registrarse:", error);
      mostrarAlerta(`Error al registrarse: ${error.message}`, "danger", authAlerta);
    }
  });

  /**
   * Maneja el inicio de sesión de un usuario existente con email y contraseña.
   */
  signInBtn.addEventListener('click', async () => {
    const email = emailInput.value;
    const password = passwordInput.value;

    if (!email || !password) {
      mostrarAlerta("Por favor, ingrese email y contraseña.", "warning", authAlerta);
      return;
    }

    try {
      await signInWithEmailAndPassword(auth, email, password);
      mostrarAlerta("¡Inicio de sesión exitoso!", "success", authAlerta);
      // onAuthStateChanged manejará la visualización de la app
    } catch (error) {
      console.error("Error al iniciar sesión:", error);
      mostrarAlerta(`Error al iniciar sesión: ${error.message}`, "danger", authAlerta);
    }
  });

  /**
   * Maneja el cierre de sesión del usuario.
   */
  logoutBtn.addEventListener('click', async () => {
    try {
      await signOut(auth);
      mostrarAlerta("Sesión cerrada correctamente.", "info", alerta);
      // onAuthStateChanged manejará la visualización del formulario de autenticación
    } catch (error) {
      console.error("Error al cerrar sesión:", error);
      mostrarAlerta(`Error al cerrar sesión: ${error.message}`, "danger", alerta);
    }
  });

  /**
   * Llena un elemento <select> con la lista de bebidas.
   * @param {HTMLElement} selectElement - El elemento select a llenar.
   */
  function populateBebidaSelect(selectElement) {
    selectElement.innerHTML = ''; // Limpiar opciones existentes
    bebidas.forEach(bebida => {
      const option = document.createElement('option');
      option.value = bebida;
      option.textContent = bebida;
      selectElement.appendChild(option);
    });
  }

  /**
   * Configura el listener en tiempo real para los movimientos de Firestore.
   * Actualiza la tabla cada vez que hay un cambio en los datos.
   */
  function setupRealtimeListener() {
    if (!db || !userId || !isAuthReady) {
      console.warn("Firestore o autenticación no listos para configurar listener.");
      return;
    }

    const movimientosCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/movimientos`);
    const q = query(movimientosCollectionRef); 

    console.log("Configurando listener en tiempo real para movimientos...");
    onSnapshot(q, (snapshot) => {
      const records = [];
      snapshot.forEach(doc => {
        records.push({ id: doc.id, ...doc.data() });
      });
      console.log("Movimientos recibidos en tiempo real:", records);

      // Ordenar los registros por fecha y luego por timestamp en JavaScript
      records.sort((a, b) => {
        const dateA = new Date(a.fecha);
        const dateB = new Date(b.fecha);
        if (dateA.getTime() !== dateB.getTime()) {
          return dateA.getTime() - dateB.getTime();
        }
        const tsA = a.timestamp ? a.timestamp.toDate().getTime() : 0;
        const tsB = b.timestamp ? b.timestamp.toDate().getTime() : 0;
        return tsA - tsB;
      });

      displayMovimientos(records);
    }, (error) => {
      console.error("Error al escuchar movimientos en tiempo real:", error);
      movimientosTableContainer.innerHTML = `<p class='text-danger text-center'>Error al cargar movimientos: ${error.message}</p>`;
    });
  }

  /**
   * Muestra los movimientos en una tabla HTML.
   * @param {Array<Object>} records - Array de objetos de movimiento.
   */
  function displayMovimientos(records) {
    if (records.length === 0) {
      movimientosTableContainer.innerHTML = "<p class='text-center text-info'>No hay movimientos registrados.</p>";
      deleteSelectedBtn.style.display = 'none'; // Ocultar el botón si no hay movimientos
      return;
    }

    let html = `<table class="table table-bordered text-center align-middle">
                  <thead class="table-dark">
                    <tr>
                      <th><input type="checkbox" id="masterCheckbox"></th> <!-- Master checkbox -->
                      <th>Fecha</th>
                      <th>Tipo</th>
                      <th>Bebida</th>
                      <th>Cantidad</th>
                      <th>Precio</th>
                      <th>Evento</th>
                      <th>Usuario</th>
                      <th>Acciones</th>
                    </tr>
                  </thead>
                  <tbody>`;

    records.forEach(r => {
      const displayFecha = r.fecha instanceof Date ? r.fecha.toISOString().split('T')[0] : r.fecha;
      html += `<tr data-doc-id="${r.id}">
        <td><input type="checkbox" class="rowCheckbox" data-doc-id="${r.id}"></td> <!-- Individual checkbox -->
        <td>${displayFecha}</td>
        <td>${r.tipo}</td>
        <td>${r.bebida}</td>
        <td>${r.cantidad}</td>
        <td>${r.precio || ''}</td>
        <td>${r.evento || ''}</td>
        <td>${r.usuario || ''}</td>
        <td>
          <button type="button" class="btn btn-sm btn-info btn-action" onclick="openEditModal('${r.id}')"><i class="fas fa-edit"></i> Editar</button>
        </td>
      </tr>`;
    });
    html += `</tbody></table>`;
    movimientosTableContainer.innerHTML = html;

    // Attach event listeners for checkboxes after table is rendered
    const masterCheckbox = document.getElementById('masterCheckbox');
    const rowCheckboxes = document.querySelectorAll('.rowCheckbox');

    if (masterCheckbox) {
      masterCheckbox.addEventListener('change', (e) => {
        rowCheckboxes.forEach(checkbox => {
          checkbox.checked = e.target.checked;
        });
        toggleDeleteSelectedButton();
      });
    }

    rowCheckboxes.forEach(checkbox => {
      checkbox.addEventListener('change', toggleDeleteSelectedButton);
    });

    toggleDeleteSelectedButton(); // Initial check for button visibility
  }

  /**
   * Muestra u oculta el botón "Eliminar Seleccionados"
   * basado en si hay checkboxes de fila marcados.
   */
  function toggleDeleteSelectedButton() {
    const checkedCheckboxes = document.querySelectorAll('.rowCheckbox:checked');
    if (checkedCheckboxes.length > 0) {
      deleteSelectedBtn.style.display = 'block';
    } else {
      deleteSelectedBtn.style.display = 'none';
    }
  }

  /**
   * Abre el modal de edición y carga los datos del movimiento seleccionado.
   * @param {string} docId - El ID del documento a editar.
   */
  window.openEditModal = async (docId) => {
    if (!db || !userId || !isAuthReady) {
      mostrarAlerta("La aplicación no está lista o el usuario no está autenticado.", "warning");
      return;
    }
    console.log("Abriendo modal para editar documento:", docId);
    try {
      const docRef = doc(db, `artifacts/${appId}/users/${userId}/movimientos`, docId);
      const docSnap = await getDoc(docRef); 
      
      if (!docSnap.exists()) {
        console.error("Documento no encontrado:", docId);
        mostrarAlerta("Movimiento no encontrado.", "danger");
        return;
      }
      
      const data = docSnap.data();
      editDocId.value = docId;
      editFecha.value = data.fecha;
      editTipo.value = data.tipo;
      editBebida.value = data.bebida;
      editCantidad.value = data.cantidad;
      editPrecio.value = data.precio || '';
      editEvento.value = data.evento || '';
      editUsuario.value = data.usuario || '';

      editMovementModal.show();
    } catch (error) {
      console.error("Error al cargar datos para edición:", error);
      mostrarAlerta("Error al cargar datos para edición: " + error.message, "danger");
    }
  };


  /**
   * Guarda los cambios de un movimiento en Firestore.
   */
  btnSaveChanges.addEventListener('click', async () => {
    if (!db || !userId || !isAuthReady) {
      mostrarAlerta("La aplicación no está lista o el usuario no está autenticado.", "warning");
      return;
    }

    const docId = editDocId.value;
    if (!docId) {
      mostrarAlerta("ID de documento no encontrado para guardar.", "danger");
      return;
    }

    const updatedData = {
      fecha: editFecha.value,
      tipo: editTipo.value,
      bebida: editBebida.value,
      cantidad: parseFloat(editCantidad.value),
      precio: editPrecio.value ? parseFloat(editPrecio.value) : "",
      evento: editEvento.value,
      usuario: editUsuario.value,
      // No actualizamos el timestamp aquí, ya que es la fecha de creación original
    };

    try {
      const docRef = doc(db, `artifacts/${appId}/users/${userId}/movimientos`, docId);
      await updateDoc(docRef, updatedData);
      mostrarAlerta("Movimiento actualizado con éxito.", "success");
      editMovementModal.hide(); // Cierra el modal
    } catch (error) {
      console.error("Error al guardar cambios:", error);
      mostrarAlerta("Error al guardar cambios: " + error.message, "danger");
    }
  });

  /**
   * Elimina un movimiento de Firestore (individual).
   */
  btnDeleteMovement.addEventListener('click', async () => {
    if (!db || !userId || !isAuthReady) {
      mostrarAlerta("La aplicación no está lista o el usuario no está autenticado.", "warning");
      return;
    }

    const docId = editDocId.value;
    if (!docId) {
      mostrarAlerta("ID de documento no encontrado para eliminar.", "danger");
      return;
    }

    // Confirmación de eliminación (usando un modal simple o confirm)
    if (!confirm("¿Estás seguro de que quieres eliminar este movimiento?")) {
      return;
    }

    try {
      const docRef = doc(db, `artifacts/${appId}/users/${userId}/movimientos`, docId);
      await deleteDoc(docRef);
      mostrarAlerta("Movimiento eliminado con éxito.", "success");
      editMovementModal.hide(); // Cierra el modal
    } catch (error) {
      console.error("Error al eliminar movimiento:", error);
      mostrarAlerta("Error al eliminar movimiento: " + error.message, "danger");
    }
  });

  /**
   * Elimina múltiples movimientos seleccionados de Firestore.
   */
  deleteSelectedBtn.addEventListener('click', async () => {
    if (!db || !userId || !isAuthReady) {
      mostrarAlerta("La aplicación no está lista o el usuario no está autenticado.", "warning");
      return;
    }

    const checkedCheckboxes = document.querySelectorAll('.rowCheckbox:checked');
    if (checkedCheckboxes.length === 0) {
      mostrarAlerta("No hay movimientos seleccionados para eliminar.", "warning");
      return;
    }

    if (!confirm(`¿Estás seguro de que quieres eliminar ${checkedCheckboxes.length} movimiento(s) seleccionado(s)?`)) {
      return;
    }

    const deletePromises = [];
    checkedCheckboxes.forEach(checkbox => {
      const docIdToDelete = checkbox.dataset.docId;
      if (docIdToDelete) {
        const docRef = doc(db, `artifacts/${appId}/users/${userId}/movimientos`, docIdToDelete);
        deletePromises.push(deleteDoc(docRef));
      }
    });

    try {
      await Promise.all(deletePromises);
      mostrarAlerta(`Se eliminaron ${checkedCheckboxes.length} movimiento(s) con éxito.`, "success");
      // La tabla se actualizará automáticamente gracias al listener en tiempo real
    } catch (error) {
      console.error("Error al eliminar movimientos seleccionados:", error);
      mostrarAlerta("Error al eliminar movimientos seleccionados: " + error.message, "danger");
    }
  });


  // Se ejecuta cuando el DOM ha sido completamente cargado
  document.addEventListener("DOMContentLoaded", () => {
    console.log("DOM Content Loaded. Iniciando Firebase...");
    initFirebase(); // Inicializa Firebase y la autenticación
  });
</script>
</body>
</html>
