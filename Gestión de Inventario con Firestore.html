<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gestión de Inventario de Bebidas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />
  <style>
    body { background-color: #f0f2f5; padding: 30px; font-family: 'Segoe UI', Tahoma; color: #333; }
    .container { background: #fff; padding: 35px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.1); }
    .card { border: none; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); margin-bottom: 30px; }
    .card-header { background-color: #007bff; color: white; font-weight: bold; border-radius: 10px 10px 0 0; padding: 15px 20px; font-size: 1.2rem; }
    .form-label { font-weight: bold; color: #555; }
    .table input[type="number"] { width: 90px; text-align: center; }
    .btn-primary:hover, .btn-secondary:hover { transform: translateY(-2px); }
    .stock-item { background: #e6f2ff; border: 1px solid #cce0ff; border-radius: 8px; padding: 10px 15px; text-align: center; min-width: 120px; max-width: 200px; flex: 1 1 auto; }
    .stock-item strong { display: block; font-size: 1.1em; color: #0056b3; }
    .stock-item span { font-size: 1.3em; font-weight: bold; color: #007bff; }
    /* Estilos para la tabla de movimientos */
    .table thead th { background-color: #495057; color: white; }
    .table tbody tr:hover { background-color: #f5f5f5; }
    .table-responsive { overflow-x: auto; }
    .bebida-adulto {
      background-color: #cccccc; /* Gris más oscuro y visible */
    }
    .medidas-container {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 30px;
      text-align: center;
    }
    .medida-item {
      max-width: 100px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    .medida-item img {
      width: 100%;
      height: auto;
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
<div class="container">
  <h1 class="text-center mb-4"><i class="fas fa-warehouse"></i> Gestión de Inventario de Bebidas</h1>

  <div class="medidas-container">
    <div class="medida-item">
      <img src="https://mymeventos.github.io/bebidas/full-bottle.png" alt="Botella llena (1)">
      <strong>1</strong>
    </div>
    <div class="medida-item">
      <img src="https://mymeventos.github.io/bebidas/3-4-bottle.png" alt="Botella 3/4 llena">
      <strong>3/4</strong>
    </div>
    <div class="medida-item">
      <img src="https://mymeventos.github.io/bebidas/half-bottle.png" alt="Botella 1/2 llena">
      <strong>1/2</strong>
    </div>
    <div class="medida-item">
      <img src="https://mymeventos.github.io/bebidas/1-4-bottle.png" alt="Botella 1/4 llena">
      <strong>1/4</strong>
    </div>
  </div>

  <div class="card">
    <div class="card-header"><i class="fas fa-plus-circle"></i> Registrar Movimiento</div>
    <div class="card-body">
      <form id="registroForm">
        <div class="row g-3 mb-3">
          <div class="col-md-3"><label class="form-label">Tipo</label><select class="form-select" id="tipo"><option value="compra">Compra</option><option value="consumo">Consumo</option><option value="merma">Merma</option></select></div>
          <div class="col-md-3"><label class="form-label">Fecha</label><input type="date" class="form-control" id="fecha" required /></div>
          <div class="col-md-3"><label class="form-label">Evento</label><input type="text" class="form-control" id="evento" /></div>
          <div class="col-md-3"><label class="form-label">Encargado</label><input type="text" class="form-control" id="usuario" /></div>
        </div>

        <table class="table table-bordered text-center align-middle">
          <thead><tr><th>Bebida</th><th>Cantidad</th><th>Precio</th></tr></thead>
          <tbody id="tablaBebidas"></tbody>
        </table>

        <button type="submit" class="btn btn-primary w-100">Registrar</button>
        <div id="alerta" class="alert d-none mt-3"></div>
      </form>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <i class="fas fa-chart-bar"></i> Stock Actual
      <button class="btn btn-sm btn-light float-end" onclick="cargarStock()">Actualizar</button>
    </div>
    <div class="card-body d-flex flex-wrap gap-3 justify-content-center" id="stockContainer">
      <p class="text-muted">Cargando stock...</p>
    </div>
  </div>
  <div class="card">
    <div class="card-header"><i class="fas fa-filter"></i> Filtrar Movimientos</div>
    <div class="card-body">
      <div class="row g-3 mb-3">
        <div class="col-md-3"><label class="form-label">Fecha</label><input type="date" class="form-control" id="filtroFecha" /></div>
        <div class="col-md-3"><label class="form-label">Tipo</label><select class="form-select" id="filtroTipo"><option value="">Todos</option><option value="compra">Compra</option><option value="consumo">Consumo</option><option value="merma">Merma</option></select></div>
        <div class="col-md-3"><label class="form-label">Evento</label><input type="text" class="form-control" id="filtroEvento" /></div>
        <div class="col-md-3"><label class="form-label">Bebida</label><select class="form-select" id="filtroBebida"></select></div>
      </div>
      <div class="d-grid gap-2">
        <button class="btn btn-secondary" onclick="filtrarRegistros()">Aplicar Filtros</button>
        <button class="btn btn-outline-secondary" onclick="limpiarFiltros()">Limpiar Filtros</button>
      </div>
      <div id="tablaRegistros" class="mt-4"><p class="text-muted text-center">Usa los filtros para ver movimientos anteriores.</p></div>
    </div>
  </div>
</div>

<script type="module">
  // Importaciones de Firebase SDK
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, onSnapshot, query, where, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // IMPORTANTE: Se ha reemplazado el uso de variables globales por la configuración que proporcionaste.
  // Tu configuración de Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCfYVuYB0azsjXohRlpt47rvIJWX31YnVg",
    authDomain: "bebidas-f2e09.firebaseapp.com",
    projectId: "bebidas-f2e09",
    storageBucket: "bebidas-f2e09.firebasestorage.app",
    messagingSenderId: "3759804003",
    appId: "1:3759804003:web:a6fc813d925c681c597256",
    measurementId: "G-JZQG7XKRJC"
  };

  // El resto del código es el mismo que antes
  let app;
  let db;
  let auth;
  let userId = null;
  let isAuthReady = false;

  const bebidas = ["Coca","Coca Zero","Sprite","Sprite Zero","Fanta","Fanta Zero","Agua","Agua Tónica","Soda","Vino Tinto","Vino Blanco","Champagne","Sidra","Cerveza","Cerveza sin Alcohol","Rutini","Trumpeter","Nicasia","Nicasia Viognier","Tardio","Sidra sin alcohol","Anana fizz","Gancia","Ron","Ron especial","Carpano rosso","Campari","Vodka","Aperol","Piña colada","Licor de Frutilla","Licor de chocolate","Licor de menta","Blue Curacao","Gin","Fernet", "Whisky","Minerva","Jugo de naranja","Pulpa de frutilla","Pulpa de melon"];

  const bebidasAdulto = ["Vino Tinto", "Vino Blanco", "Champagne", "Sidra", "Cerveza", "Cerveza sin Alcohol", "Rutini", "Trumpeter", "Nicasia", "Nicasia Viognier", "Tardio", "Sidra sin alcohol", "Anana fizz", "Gancia", "Ron", "Ron especial", "Carpano rosso", "Campari", "Vodka", "Aperol", "Piña colada", "Licor de Frutilla", "Licor de chocolate", "Licor de menta", "Blue Curacao", "Gin", "Fernet", "Whisky"];

  const tbody = document.getElementById("tablaBebidas");
  const stockContainer = document.getElementById("stockContainer");
  const filtroBebidaSelect = document.getElementById("filtroBebida");
  const alerta = document.getElementById("alerta");

  async function initFirebase() {
    console.log("Iniciando Firebase...");
    try {
      app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      auth = getAuth(app);

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          userId = user.uid;
          isAuthReady = true;
          console.log("Usuario autenticado:", userId);
          cargarStock();
          generarTabla();
          console.log("Generación de tabla y carga de stock iniciadas tras autenticación.");
        } else {
          console.log("No hay usuario autenticado, intentando autenticación anónima...");
          try {
            await signInAnonymously(auth);
            console.log("Autenticación anónima exitosa.");
          } catch (error) {
            console.error("Error al autenticar:", error);
            mostrarAlerta("Error al autenticar. Intente de nuevo.", "danger");
            isAuthReady = false;
            stockContainer.innerHTML = "<p class='text-danger'>Error al autenticar. No se puede cargar el stock.</p>";
          }
        }
      });
    } catch (error) {
      console.error("Error al inicializar Firebase:", error);
      mostrarAlerta("Error al inicializar la aplicación. Verifique la configuración.", "danger");
      isAuthReady = false;
      stockContainer.innerHTML = "<p class='text-danger'>Error al inicializar la aplicación. No se puede cargar el stock.</p>";
    }
  }

  function generarTabla() {
    console.log("Generando tabla de bebidas...");
    tbody.innerHTML = "";
    filtroBebidaSelect.innerHTML = '<option value="">Todas</option>';
    if (bebidas.length === 0) {
        console.warn("La lista de bebidas está vacía. No se generarán filas.");
        tbody.innerHTML = '<tr><td colspan="3" class="text-muted">No hay bebidas configuradas.</td></tr>';
        return;
    }
    bebidas.forEach(b => {
      const isAdulto = bebidasAdulto.includes(b);
      const rowClass = isAdulto ? 'class="bebida-adulto"' : '';
      tbody.innerHTML += `<tr ${rowClass}><td>${b}</td><td><input type="number" class="form-control cantidad" data-bebida="${b}" min="0" value="0" /></td><td><input type="number" class="form-control precio" data-bebida="${b}" min="0" step="0.01" /></td></tr>`;
      filtroBebidaSelect.innerHTML += `<option value="${b}">${b}</option>`;
    });
    console.log("Tabla de bebidas generada.");
  }

  document.getElementById("registroForm").addEventListener("submit", async e => {
    e.preventDefault();

    const submitBtn = e.submitter;
    submitBtn.disabled = true;
    submitBtn.textContent = "Registrando...";

    if (!db || !userId || !isAuthReady) {
      mostrarAlerta("La aplicación no está lista o el usuario no está autenticado.", "warning");
      console.warn("Intento de registro fallido: Firebase o autenticación no listos.");
      submitBtn.disabled = false;
      submitBtn.textContent = "Registrar";
      return;
    }

    const tipo = document.getElementById("tipo").value;
    const fecha = document.getElementById("fecha").value;
    const evento = document.getElementById("evento").value;
    const usuario = document.getElementById("usuario").value;

    const cantidades = document.querySelectorAll(".cantidad");
    const precios = document.querySelectorAll(".precio");

    let registros = [];

    cantidades.forEach((input, i) => {
      const cantidad = parseFloat(input.value);
      if (!isNaN(cantidad) && cantidad > 0) {
        const bebida = input.dataset.bebida;
        const precio = parseFloat(precios[i].value);
        registros.push({
          tipo,
          fecha,
          evento,
          usuario,
          bebida,
          cantidad,
          precio: isNaN(precio) ? "" : precio,
          timestamp: serverTimestamp()
        });
      }
    });

    if (registros.length === 0) {
      mostrarAlerta("Ingrese al menos una bebida", "warning");
      submitBtn.disabled = false;
      submitBtn.textContent = "Registrar";
      return;
    }

    try {
      const movimientosCollectionRef = collection(db, `bebidas`);

      console.log("Enviando registros a Firestore:", registros);
      await Promise.all(registros.map(dato => addDoc(movimientosCollectionRef, dato)));

      mostrarAlerta("¡Registro exitoso!", "success");
      document.getElementById("registroForm").reset();
      generarTabla();
      console.log("Registros enviados con éxito.");
    } catch (error) {
      console.error("Error al registrar movimiento en Firestore:", error);
      mostrarAlerta("Error al registrar: " + error.message, "danger");
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = "Registrar";
    }
  });

  function mostrarAlerta(msg, tipo) {
    alerta.textContent = msg;
    alerta.className = `alert alert-${tipo}`;
    alerta.classList.remove("d-none");
    setTimeout(() => alerta.classList.add("d-none"), 4000);
  }

  function cargarStock() {
    if (!db || !userId || !isAuthReady) {
      stockContainer.innerHTML = "<p class='text-muted'>Esperando autenticación para cargar stock...</p>";
      console.log("Cargar stock: Firebase o autenticación no listos.");
      return;
    }

    stockContainer.innerHTML = "<p class='text-muted'>Cargando stock...</p>";
    const movimientosCollectionRef = collection(db, `bebidas`);

    console.log("Configurando listener de stock en tiempo real...");
    onSnapshot(movimientosCollectionRef, (snapshot) => {
      let stock = {};
      if (snapshot.empty) {
        console.log("No hay documentos en la colección de movimientos.");
      }
      snapshot.docs.forEach(doc => {
        const data = doc.data();
        const tipo = data.tipo;
        const bebida = data.bebida;
        const cantidad = parseFloat(data.cantidad);

        if (bebida && !isNaN(cantidad)) {
          if (!stock[bebida]) {
            stock[bebida] = 0;
          }
          if (tipo === "compra") {
            stock[bebida] += cantidad;
          } else if (tipo === "consumo" || tipo === "merma") {
            stock[bebida] -= cantidad;
          }
        }
      });

      stockContainer.innerHTML = "";
      if (Object.keys(stock).length === 0) {
        stockContainer.innerHTML = "<p class='text-center text-info'>No hay stock registrado.</p>";
        console.log("Stock calculado: Vacío.");
        return;
      }

      bebidas.forEach(b => {
        const cantidad = stock[b] || 0;
        stockContainer.innerHTML += `<div class="stock-item"><strong>${b}</strong><span>${cantidad}</span></div>`;
      });
      console.log("Stock actualizado y mostrado:", stock);
    }, (error) => {
      console.error("Error al cargar stock en tiempo real:", error);
      stockContainer.innerHTML = `<p class='text-danger'>Error al cargar stock: ${error.message}</p>`;
    });
  }

  async function filtrarRegistros() {
    const tabla = document.getElementById("tablaRegistros");
    tabla.innerHTML = "<p class='text-center text-muted'>Cargando...</p>";

    if (!db || !userId || !isAuthReady) {
      tabla.innerHTML = "<p class='text-muted'>Esperando autenticación para filtrar...</p>";
      console.warn("Filtrar registros: Firebase o autenticación no listos.");
      return;
    }

    const filtroFecha = document.getElementById("filtroFecha").value;
    const filtroTipo = document.getElementById("filtroTipo").value;
    const filtroEvento = document.getElementById("filtroEvento").value;
    const filtroBebida = filtroBebidaSelect.value;

    const movimientosCollectionRef = collection(db, `bebidas`);
    let q = query(movimientosCollectionRef);

    if (filtroFecha) {
      q = query(q, where("fecha", "==", filtroFecha));
    }
    if (filtroTipo) {
      q = query(q, where("tipo", "==", filtroTipo));
    }
    if (filtroBebida) {
      q = query(q, where("bebida", "==", filtroBebida));
    }

    console.log("Aplicando filtros y obteniendo registros...");
    try {
      const querySnapshot = await getDocs(q);
      let records = [];
      querySnapshot.forEach(doc => {
        let data = doc.data();
        if (filtroEvento && data.evento && !data.evento.toLowerCase().includes(filtroEvento.toLowerCase())) {
          return;
        }
        records.push(data);
      });

      records.sort((a, b) => {
        const dateA = new Date(a.fecha);
        const dateB = new Date(b.fecha);
        if (dateA.getTime() !== dateB.getTime()) {
          return dateA.getTime() - dateB.getTime();
        }
        const tsA = a.timestamp ? a.timestamp.toDate().getTime() : 0;
        const tsB = b.timestamp ? b.timestamp.toDate().getTime() : 0;
        return tsA - tsB;
      });

      if (records.length === 0) {
        tabla.innerHTML = "<p class='text-center text-info'>Sin resultados</p>";
        console.log("Filtrado: Sin resultados.");
        return;
      }

      let html = `<div class="table-responsive"><table class="table table-bordered text-center align-middle"><thead class="table-dark"><tr><th>Fecha</th><th>Tipo</th><th>Bebida</th><th>Cantidad</th><th>Evento</th><th>Usuario</th><th>Precio</th><th>Total</th></tr></thead><tbody>`;
      records.forEach(r => {
        const displayFecha = r.fecha instanceof Date ? r.fecha.toISOString().split('T')[0] : r.fecha;
        const total = (r.cantidad && r.precio) ? (parseFloat(r.cantidad) * parseFloat(r.precio)).toFixed(2) : "";
        html += `<tr><td>${displayFecha}</td><td>${r.tipo}</td><td>${r.bebida}</td><td>${r.cantidad}</td><td>${r.evento}</td><td>${r.usuario}</td><td>${r.precio || ''}</td><td>${total}</td></tr>`;
      });
      html += "</tbody></table></div>";
      tabla.innerHTML = html;
      console.log("Registros filtrados mostrados.");
    } catch (error) {
      console.error("Error al filtrar registros de Firestore:", error);
      tabla.innerHTML = `<p class='text-danger text-center'>Error al filtrar: ${error.message}</p>`;
    }
  }

  function limpiarFiltros() {
    document.getElementById("filtroFecha").value = "";
    document.getElementById("filtroTipo").value = "";
    document.getElementById("filtroEvento").value = "";
    filtroBebidaSelect.value = "";
    document.getElementById("tablaRegistros").innerHTML = "<p class='text-muted text-center'>Usa los filtros para ver movimientos anteriores.</p>";
    console.log("Filtros limpiados.");
  }

  document.addEventListener("DOMContentLoaded", () => {
    console.log("DOM Content Loaded. Iniciando Firebase...");
    initFirebase();
    document.getElementById("fecha").valueAsDate = new Date();
  });
</script>
</body>
</html>
