<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gestión de Inventario de Bebidas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />
  <style>
    body { background-color: #f0f2f5; padding: 30px; font-family: 'Segoe UI', Tahoma; color: #333; }
    .container { background: #fff; padding: 35px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.1); }
    .card { border: none; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); margin-bottom: 30px; }
    .card-header { background-color: #007bff; color: white; font-weight: bold; border-radius: 10px 10px 0 0; padding: 15px 20px; font-size: 1.2rem; }
    .form-label { font-weight: bold; color: #555; }
    .table input[type="number"] { width: 90px; text-align: center; }
    .btn-primary:hover, .btn-secondary:hover { transform: translateY(-2px); }
    .stock-item { background: #e6f2ff; border: 1px solid #cce0ff; border-radius: 8px; padding: 10px 15px; text-align: center; min-width: 120px; max-width: 200px; flex: 1 1 auto; }
    .stock-item strong { display: block; font-size: 1.1em; color: #0056b3; }
    .stock-item span { font-size: 1.3em; font-weight: bold; color: #007bff; }
    /* Nuevos estilos para tabla de movimientos si los necesitas */
    .table thead th { background-color: #495057; color: white; }
    .table tbody tr:hover { background-color: #f5f5f5; }
    .table-responsive { overflow-x: auto; }
  </style>
</head>
<body>
<div class="container">
  <h1 class="text-center mb-4"><i class="fas fa-warehouse"></i> Gestión de Inventario de Bebidas</h1>

  <div class="card">
    <div class="card-header"><i class="fas fa-plus-circle"></i> Registrar Movimiento</div>
    <div class="card-body">
      <form id="registroForm">
        <div class="row g-3 mb-3">
          <div class="col-md-3"><label class="form-label">Tipo</label><select class="form-select" id="tipo"><option value="compra">Compra</option><option value="consumo">Consumo</option><option value="merma">Merma</option></select></div>
          <div class="col-md-3"><label class="form-label">Fecha</label><input type="date" class="form-control" id="fecha" required /></div>
          <div class="col-md-3"><label class="form-label">Evento</label><input type="text" class="form-control" id="evento" /></div>
          <div class="col-md-3"><label class="form-label">Encargado</label><input type="text" class="form-control" id="usuario" /></div>
        </div>

        <table class="table table-bordered text-center align-middle">
          <thead><tr><th>Bebida</th><th>Cantidad</th><th>Precio</th></tr></thead>
          <tbody id="tablaBebidas"></tbody>
        </table>

        <button type="submit" class="btn btn-primary w-100">Registrar</button>
        <div id="alerta" class="alert d-none mt-3"></div>
      </form>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <i class="fas fa-chart-bar"></i> Stock Actual
      <button class="btn btn-sm btn-light float-end" onclick="cargarStock()">Actualizar</button>
    </div>
    <div class="card-body d-flex flex-wrap gap-3 justify-content-center" id="stockContainer">
      <p class="text-muted">Cargando stock...</p>
    </div>
  </div>
  <div class="card">
    <div class="card-header"><i class="fas fa-filter"></i> Filtrar Movimientos</div>
    <div class="card-body">
      <div class="row g-3 mb-3">
        <div class="col-md-3"><label class="form-label">Fecha</label><input type="date" class="form-control" id="filtroFecha" /></div>
        <div class="col-md-3"><label class="form-label">Tipo</label><select class="form-select" id="filtroTipo"><option value="">Todos</option><option value="compra">Compra</option><option value="consumo">Consumo</option><option value="merma">Merma</option></select></div>
        <div class="col-md-3"><label class="form-label">Evento</label><input type="text" class="form-control" id="filtroEvento" /></div>
        <div class="col-md-3"><label class="form-label">Bebida</label><select class="form-select" id="filtroBebida"></select></div>
      </div>
      <div class="d-grid gap-2">
        <button class="btn btn-secondary" onclick="filtrarRegistros()">Aplicar Filtros</button>
        <button class="btn btn-outline-secondary" onclick="limpiarFiltros()">Limpiar Filtros</button>
      </div>
      <div id="tablaRegistros" class="mt-4"><p class="text-muted text-center">Usa los filtros para ver movimientos anteriores.</p></div>
    </div>
  </div>
</div>

<script>
// ** TU URL DE GOOGLE APPS SCRIPT AQUÍ **
const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbyUmAZvT7jEKNlu93vzZQtwQkXVT-yZYmdeeXSXbBKZUB-cqY4WrUWRRxyLbRZbpGzt/exec";

const bebidas = ["Coca","Coca Zero","Sprite","Sprite Zero","Fanta","Fanta Zero","Agua","Agua Tónica","Soda","Vino Tinto","Vino Blanco","Champagne","Sidra","Cerveza","Cerveza sin Alcohol"];
const tbody = document.getElementById("tablaBebidas");
const stockContainer = document.getElementById("stockContainer");
const filtroBebidaSelect = document.getElementById("filtroBebida"); // Renombrado para evitar conflicto con variable global 'filtroBebida' en limpiarFiltros

function generarTabla() {
  tbody.innerHTML = "";
  filtroBebidaSelect.innerHTML = '<option value="">Todas</option>';
  bebidas.forEach(b => {
    tbody.innerHTML += `<tr><td>${b}</td><td><input type="number" class="form-control cantidad" data-bebida="${b}" min="0" value="0" /></td><td><input type="number" class="form-control precio" data-bebida="${b}" min="0" step="0.01" /></td></tr>`;
    filtroBebidaSelect.innerHTML += `<option value="${b}">${b}</option>`;
  });
}

document.getElementById("registroForm").addEventListener("submit", async e => {
  e.preventDefault();
  const tipo = document.getElementById("tipo").value;
  const fecha = document.getElementById("fecha").value;
  const evento = document.getElementById("evento").value;
  const usuario = document.getElementById("usuario").value;

  const cantidades = document.querySelectorAll(".cantidad");
  const precios = document.querySelectorAll(".precio");
  const alerta = document.getElementById("alerta");

  let registros = [];
  cantidades.forEach((input, i) => {
    const cantidad = parseFloat(input.value);
    if (!isNaN(cantidad) && cantidad > 0) {
      const bebida = input.dataset.bebida;
      const precio = parseFloat(precios[i].value);
      registros.push({
        tipo, fecha, evento, usuario, bebida, cantidad,
        precio: isNaN(precio) ? "" : precio
      });
    }
  });

  if (registros.length === 0) return mostrarAlerta("Ingrese al menos una bebida", "warning");

  try {
    const responses = await Promise.all(registros.map(async d => // Usamos async para manejar la respuesta
      {
        const res = await fetch(URL_SCRIPT, {
          method: "POST",
          // *** IMPORTANTE: ELIMINADO mode: "no-cors" ***
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(d)
        });
        if (!res.ok) { // Verifica si la respuesta HTTP es un error (ej. 404, 500)
            const errorText = await res.text(); // Intenta leer el cuerpo del error
            throw new Error(`Error en el servidor: ${res.status} ${res.statusText} - ${errorText}`);
        }
        return res.json(); // Parsea la respuesta JSON del Apps Script
      }
    ));

    // Verificar si todas las operaciones fueron exitosas según la respuesta JSON
    const allSuccess = responses.every(r => r.success === true);

    if (allSuccess) {
        mostrarAlerta("¡Registro exitoso!", "success");
        document.getElementById("registroForm").reset();
        generarTabla();
        cargarStock();
    } else {
        // En caso de que alguna respuesta JSON no indique éxito
        const errorMessages = responses.map(r => r.error).filter(Boolean).join("; ");
        mostrarAlerta("Error al registrar: " + (errorMessages || "Algunos registros fallaron."), "danger");
    }

  } catch (error) { // Captura errores de red o errores lanzados desde el bloque try interno
    console.error("Error al registrar movimiento:", error);
    mostrarAlerta("Error de conexión o al registrar: " + error.message, "danger");
  }
});

function mostrarAlerta(msg, tipo) {
  const alerta = document.getElementById("alerta");
  alerta.textContent = msg;
  alerta.className = `alert alert-${tipo}`;
  alerta.classList.remove("d-none");
  setTimeout(() => alerta.classList.add("d-none"), 4000);
}

async function cargarStock() {
  stockContainer.innerHTML = "<p class='text-muted'>Cargando stock...</p>";
  try {
    const r = await fetch(`${URL_SCRIPT}?requestType=currentStock`);
    if (!r.ok) {
        throw new Error(`Error al obtener stock: ${r.status} ${r.statusText}`);
    }
    const data = await r.json();

    stockContainer.innerHTML = "";
    if (Object.keys(data).length === 0) { // Si no hay datos de stock
      stockContainer.innerHTML = "<p class='text-center text-info'>No hay stock registrado.</p>";
      return;
    }

    bebidas.forEach(b => {
      const cantidad = data[b] || 0; // *** CORREGIDO: data[b] en lugar de data.stock[b] ***
      stockContainer.innerHTML += `<div class="stock-item"><strong>${b}</strong><span>${cantidad}</span></div>`;
    });
  } catch (error) {
    console.error("Error al cargar stock:", error);
    stockContainer.innerHTML = `<p class='text-danger'>Error al cargar stock: ${error.message}</p>`;
  }
}

async function filtrarRegistros() {
  const tabla = document.getElementById("tablaRegistros");
  tabla.innerHTML = "<p class='text-center text-muted'>Cargando...</p>";

  const filtroFecha = document.getElementById("filtroFecha").value;
  const filtroTipo = document.getElementById("filtroTipo").value;
  const filtroEvento = document.getElementById("filtroEvento").value;
  const filtroBebida = filtroBebidaSelect.value; // Usar la variable renombrada

  let params = new URLSearchParams({ // *** MEJORA: Usar URLSearchParams para codificación correcta ***
    requestType: "filteredRecords",
    filtroFecha: filtroFecha,
    filtroTipo: filtroTipo,
    filtroEvento: filtroEvento,
    filtroBebida: filtroBebida
  }).toString();

  try {
    const res = await fetch(`${URL_SCRIPT}?${params}`);
    if (!res.ok) {
        throw new Error(`Error al filtrar registros: ${res.status} ${res.statusText}`);
    }
    const data = await res.json();

    if (data.error) {
      tabla.innerHTML = `<p class='text-danger text-center'>Error: ${data.error}</p>`;
      return;
    }

    if (!data.records || data.records.length === 0) {
      tabla.innerHTML = "<p class='text-center text-info'>Sin resultados</p>";
      return;
    }

    let html = `<div class="table-responsive"><table class="table table-bordered text-center align-middle"><thead class="table-dark"><tr><th>Fecha</th><th>Tipo</th><th>Bebida</th><th>Cantidad</th><th>Evento</th><th>Usuario</th><th>Precio</th><th>Total</th></tr></thead><tbody>`;
    data.records.forEach(r => {
      const total = (r.Cantidad && r.Precio) ? (parseFloat(r.Cantidad) * parseFloat(r.Precio)).toFixed(2) : "";
      html += `<tr><td>${r.Fecha}</td><td>${r.Tipo}</td><td>${r.Bebida}</td><td>${r.Cantidad}</td><td>${r.Evento}</td><td>${r.Usuario}</td><td>${r.Precio}</td><td>${total}</td></tr>`;
    });
    html += "</tbody></table></div>";
    tabla.innerHTML = html;
  } catch (error) {
    console.error("Error al filtrar:", error);
    tabla.innerHTML = `<p class='text-danger text-center'>Error al filtrar o problema de conexión: ${error.message}</p>`;
  }
}

function limpiarFiltros() {
  document.getElementById("filtroFecha").value = "";
  document.getElementById("filtroTipo").value = "";
  document.getElementById("filtroEvento").value = "";
  filtroBebidaSelect.value = ""; // Usar la variable renombrada
  document.getElementById("tablaRegistros").innerHTML = "<p class='text-muted text-center'>Usa los filtros para ver movimientos anteriores.</p>";
}

document.addEventListener("DOMContentLoaded", () => {
  generarTabla();
  cargarStock();
  document.getElementById("fecha").valueAsDate = new Date();
});
</script>
</body>
</html>
