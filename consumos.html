<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Registro de Consumos</title>
  <link rel="icon" href="https://mymeventos.github.io/bebidas/mi-icono.png" type="image/png">
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />
  <style>
    body { background-color: #f0f2f5; padding: 30px; font-family: 'Segoe UI', Tahoma; color: #333; transition: background-color 0.5s ease; }
    .container { background: #fff; padding: 35px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0/0,0.1); }
    .card { border: none; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0/0,0.08); margin-bottom: 30px; }
    .card-header { background-color: #007bff; color: white; font-weight: bold; border-radius: 10px 10px 0 0; padding: 15px 20px; font-size: 1.2rem; }
    .form-label { font-weight: bold; color: #555; }
    .table input.cantidad-entero { width: 90px; text-align: center; }
    .btn-primary:hover, .btn-secondary:hover { transform: translateY(-2px); }
    .stock-item { background: #e6f2ff; border: 1px solid #cce0ff; border-radius: 8px; padding: 10px 15px; text-align: center; min-width: 120px; max-width: 200px; flex: 1 1 auto; }
    .stock-item strong { display: block; font-size: 1.1em; color: #0056b3; }
    .stock-item span { font-size: 1.3em; font-weight: bold; color: #007bff; }
    /* Estilos para la tabla de movimientos */
    .table thead th { background-color: #495057; color: white; }
    .table tbody tr:hover { background-color: #f5f5f5; }
    .table-responsive { overflow-x: auto; }
    /* Estilo para el total general */
    .total-general-row {
      font-weight: bold;
      background-color: #e9ecef;
    }
    .total-general-row td {
      padding: 0.75rem;
      border-top: 2px solid #dee2d6;
    }
    #authContainer {
      max-width: 400px;
      margin: 50px auto;
      padding: 30px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0,0/0,0.1);
    }
    /* Estilos para la alerta más grande y visible */
    .alert-big {
      font-size: 1.5rem;
      padding: 1.5rem;
      text-align: center;
      margin-top: 20px;
      margin-bottom: 20px;
    }
    /* Clase para el fondo verde de éxito */
    .bg-success-flash {
      background-color: #d4edda !important;
    }
    .medidas-container {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 30px;
      text-align: center;
    }
    .medida-item {
      max-width: 100px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    .medida-item img {
      width: 100%;
      height: auto;
      margin-bottom: 5px;
    }
    /* Nuevos estilos para los botones de fracción */
    .btn-secondary {
      background-color: #f0f2f5;
      color: #333;
      border-color: #e0e0e0;
    }
    .btn-secondary:hover {
      background-color: #e9ecef;
      color: #333;
      border-color: #ccc;
    }
    .btn-check:checked + .btn-secondary {
      background-color: #0d6efd; /* Color azul de Bootstrap */
      color: white;
      border-color: #0d6efd;
    }
    /* Estilos para las filas de bebidas de barra */
    .bebida-adulto {
      background-color: #4a5568; /* Fondo gris oscuro para la sección de barra */
      color: white; /* Letras blancas para contraste */
    }
    /* Estilos para los separadores */
    .seccion-separador {
      background-color: #007bff; /* Fondo azul para Salón */
      color: white;
      font-weight: bold;
      text-align: left;
      padding: 10px;
      font-size: 1.1em;
    }
    /* Estilo del separador de barra con color de fondo más resaltado */
    .barra-separador {
      background-color: #4a5568; /* Fondo gris oscuro para Barra */
      color: #cce0ff; /* Letras azul claro para contraste */
      font-weight: bold;
      text-align: left;
      padding: 10px;
      font-size: 1.1em;
    }
    /* Nuevo estilo para la alerta de éxito a pantalla completa */
    .alert-fullscreen-success {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #28a745; /* Verde más intenso */
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 3rem;
      z-index: 9999;
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
    }
    .alert-fullscreen-success.show {
      opacity: 1;
    }
  </style>
</head>
<body>
<div id="appContent" style="display: none;">
  <div class="container bg-white p-4 rounded shadow">
    <h1 class="text-center mb-4">🍷 Registro de Consumos</h1>
    <p class="text-muted text-center" id="currentUserIdDisplay">Cargando ID de usuario...</p>
    <div class="text-center mb-3">
      <button id="logoutBtn" class="btn btn-outline-danger btn-sm"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</button>
    </div>

    <div class="medidas-container">
      <div class="medida-item">
        <img src="https://mymeventos.github.io/bebidas/full-bottle.png" alt="Botella llena (1)">
        <strong>1</strong>
      </div>
      <div class="medida-item">
        <img src="https://mymeventos.github.io/bebidas/3-4-bottle.png" alt="Botella 3/4 llena">
        <strong>3/4</strong>
      </div>
      <div class="medida-item">
        <img src="https://mymeventos.github.io/bebidas/half-bottle.png" alt="Botella 1/2 llena">
        <strong>1/2</strong>
      </div>
      <div class="medida-item">
        <img src="https://mymeventos.github.io/bebidas/1-4-bottle.png" alt="Botella 1/4 llena">
        <strong>1/4</strong>
      </div>
    </div>

    <form id="formConsumo">
      <div class="row g-3 mb-3">
        <div class="col-md-4"><label class="form-label">Fecha</label><input type="date" class="form-control" id="fecha" required /></div>
        <div class="col-md-5"><label class="form-label">Evento</label><input type="text" class="form-control" id="evento" /></div>
        <div class="col-md-3"><label class="form-label">Encargado</label><input type="text" class="form-control" id="usuario" /></div>
      </div>

      <div class="table-responsive">
        <table class="table table-bordered text-center align-middle">
          <thead><tr><th>Bebida</th><th>Cantidad</th></tr></thead>
          <tbody id="tablaConsumo"></tbody>
        </table>
      </div>

      <div id="alerta" class="alert d-none alert-big"></div>

      <button type="submit" class="btn btn-danger w-100 mt-3" id="submitBtn">Registrar</button>
    </form>
  </div>
</div>

<div id="authContainer">
  <h2 class="text-center mb-4">Iniciar Sesión / Registrarse</h2>
  <div class="mb-3">
    <label for="emailInput" class="form-label">Email</label>
    <input type="email" class="form-control" id="emailInput" placeholder="tu@email.com" required>
  </div>
  <div class="mb-3">
    <label for="passwordInput" class="form-label">Contraseña</label>
    <input type="password" class="form-control" id="passwordInput" placeholder="********" required>
  </div>
  <div class="d-grid gap-2">
    <button id="signInBtn" class="btn btn-primary">Iniciar Sesión</button>
    <button id="signUpBtn" class="btn btn-secondary">Registrarse</button>
  </div>
  <div id="authAlerta" class="alert d-none mt-3"></div>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>
<script type="module">
  // Importaciones de Firebase SDK
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, serverTimestamp, getDocs, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // Variables globales proporcionadas por el entorno de Canvas
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
  // Configuración de Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCfYVuYB0azsjXohRlpt47rvIJWX31YnVg",
    authDomain: "bebidas-f2e09.firebaseapp.com",
    projectId: "bebidas-f2e09",
    storageBucket: "bebidas-f2e09.firebasestorage.app",
    messagingSenderId: "3759804003",
    appId: "1:3759804003:web:a6fc813d925c681c597256",
    measurementId: "G-JZQG7XKRJC"
  };
  const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

  // Inicialización de Firebase
  let app;
  let db;
  let auth;
  let userId = null;

  // Lista de bebidas disponibles
  const bebidasSalon = ["Coca","Coca Zero","Sprite","Sprite Zero","Fanta","Fanta Zero","Agua","Agua Tónica","Soda", "Jugo de naranja", "Pulpa de frutilla", "Pulpa de melon", "Vino Tinto","Vino Blanco","Champagne","Sidra","Cerveza","Cerveza sin Alcohol","Rutini","Trumpeter","Nicasia","Nicasia Viognier","Tardio","Sidra sin alcohol","Anana fizz", "pulpa arandano", "pulpa frambuesa", "pulpa durazno", "alambrado malbec", "santa julia cuve"];
  const bebidasAdulto = ["Gancia","Ron","Ron especial","Carpano rosso","Campari","Vodka","Aperol","Piña colada","Licor de Frutilla","Licor de chocolate","Licor de menta","Blue Curacao","Gin","Fernet", "Whisky","Minerva"];
  const bebidas = [...bebidasSalon, ...bebidasAdulto];
  

  // Referencias a elementos del DOM de la aplicación principal
  const appContent = document.getElementById("appContent");
  const tbody = document.getElementById("tablaConsumo");
  const alerta = document.getElementById("alerta");
  const currentUserIdDisplay = document.getElementById("currentUserIdDisplay"); 
  const logoutBtn = document.getElementById("logoutBtn");
  const submitBtn = document.getElementById("submitBtn"); // Referencia al botón de envío

  // Referencias a elementos del DOM de autenticación
  const authContainer = document.getElementById("authContainer");
  const emailInput = document.getElementById("emailInput");
  const passwordInput = document.getElementById("passwordInput");
  const signInBtn = document.getElementById("signInBtn");
  const signUpBtn = document.getElementById("signUpBtn");
  const authAlerta = document.getElementById("authAlerta");


  /**
   * Muestra una alerta temporal.
   * @param {string} msg - El mensaje a mostrar.
   * @param {string} tipo - El tipo de alerta (ej. "success", "warning", "danger").
   * @param {HTMLElement} targetAlerta - El elemento de alerta donde mostrar el mensaje.
   */
  function mostrarAlerta(msg, tipo, targetAlerta = alerta) {
    targetAlerta.textContent = msg;
    targetAlerta.className = `alert alert-${tipo} alert-big`; 
    targetAlerta.classList.remove("d-none");
    
    if (tipo === "success") {
      // Usar el estilo de fondo para el cuerpo de la página
      document.body.classList.add("bg-success-flash");
    }

    setTimeout(() => {
      targetAlerta.classList.add("d-none");
      document.body.classList.remove("bg-success-flash");
    }, 4000);
  }

  /**
   * Inicializa Firebase y configura el listener de autenticación.
   */
  async function initFirebase() {
    try {
      app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      auth = getAuth(app);

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          userId = user.uid;
          console.log("Usuario autenticado:", userId);
          currentUserIdDisplay.textContent = `ID de Usuario: ${userId}`;
          appContent.style.display = 'block';
          authContainer.style.display = 'none';
          generarFilas();
        } else {
          userId = null;
          console.log("No hay usuario autenticado.");
          currentUserIdDisplay.textContent = `ID de Usuario: No autenticado`;
          appContent.style.display = 'none';
          authContainer.style.display = 'block';
        }
      });
    } catch (error) {
      console.error("Error al inicializar Firebase:", error);
      mostrarAlerta("Error al inicializar la aplicación. Verifique la configuración.", "danger", authAlerta);
    }
  }

  /**
   * Maneja el registro de un nuevo usuario con email y contraseña.
   */
  signUpBtn.addEventListener('click', async () => {
    const email = emailInput.value;
    const password = passwordInput.value;

    if (!email || !password) {
      mostrarAlerta("Por favor, ingrese email y contraseña.", "warning", authAlerta);
      return;
    }

    try {
      await createUserWithEmailAndPassword(auth, email, password);
      mostrarAlerta("¡Registro exitoso! Sesión iniciada.", "success", authAlerta);
    } catch (error) {
      console.error("Error al registrarse:", error);
      mostrarAlerta(`Error al registrarse: ${error.message}`, "danger", authAlerta);
    }
  });

  /**
   * Maneja el inicio de sesión de un usuario existente con email y contraseña.
   */
  signInBtn.addEventListener('click', async () => {
    const email = emailInput.value;
    const password = passwordInput.value;

    if (!email || !password) {
      mostrarAlerta("Por favor, ingrese email y contraseña.", "warning", authAlerta);
      return;
    }

    try {
      await signInWithEmailAndPassword(auth, email, password);
      mostrarAlerta("¡Inicio de sesión exitoso!", "success", authAlerta);
    } catch (error) {
      console.error("Error al iniciar sesión:", error);
      mostrarAlerta(`Error al iniciar sesión: ${error.message}`, "danger", authAlerta);
    }
  });

  /**
   * Maneja el cierre de sesión del usuario.
   */
  logoutBtn.addEventListener('click', async () => {
    try {
      await signOut(auth);
      mostrarAlerta("Sesión cerrada correctamente.", "info", alerta);
    } catch (error) {
      console.error("Error al cerrar sesión:", error);
      mostrarAlerta(`Error al cerrar sesión: ${error.message}`, "danger", alerta);
    }
  });


  /**
   * Genera dinámicamente las filas de la tabla de consumo con campos de entrada para cada bebida.
   */
  function generarFilas() {
    tbody.innerHTML = "";
    
    // Sección Salón (se registra el stock final)
    tbody.innerHTML += `<tr><td colspan="2" class="seccion-separador">Sección Salón (ingresar stock final)</td></tr>`;
    bebidasSalon.forEach(b => {
      const inputCantidad = `<input type="number" class="form-control cantidad-entero" data-bebida="${b}" min="0" value="0" style="width: 90px; display: inline-block;">`;
      const radioFracciones = `
        <div class="btn-group" role="group" aria-label="Fracciones">
          <input type="radio" class="btn-check" name="fraccion-${b}" id="fraccion-${b}-1-4" value="0.25" autocomplete="off">
          <label class="btn btn-secondary btn-sm" for="fraccion-${b}-1-4">1/4</label>
          <input type="radio" class="btn-check" name="fraccion-${b}" id="fraccion-${b}-1-2" value="0.5" autocomplete="off">
          <label class="btn btn-secondary btn-sm" for="fraccion-${b}-1-2">1/2</label>
          <input type="radio" class="btn-check" name="fraccion-${b}" id="fraccion-${b}-3-4" value="0.75" autocomplete="off">
          <label class="btn btn-secondary btn-sm" for="fraccion-${b}-3-4">3/4</label>
        </div>
        <span class="btn btn-sm btn-link text-danger p-0 ms-2 deseleccionar-fraccion" data-bebida="${b}" style="cursor: pointer;">
          <i class="fas fa-times-circle"></i>
        </span>
      `;
      tbody.innerHTML += `<tr>
        <td>${b}</td>
        <td>
          <div class="d-flex justify-content-center align-items-center gap-2">
            ${inputCantidad}
            ${radioFracciones}
          </div>
        </td>
      </tr>`;
    });

    // Sección Barra (se registra el stock final)
    tbody.innerHTML += `<tr><td colspan="2" class="barra-separador">Sección Barra (ingresar stock final)</td></tr>`;
    bebidasAdulto.forEach(b => {
      const inputCantidad = `<input type="number" class="form-control cantidad-entero" data-bebida="${b}" min="0" value="0" style="width: 90px; display: inline-block;">`;
      const radioFracciones = `
        <div class="btn-group" role="group" aria-label="Fracciones">
          <input type="radio" class="btn-check" name="fraccion-${b}" id="fraccion-${b}-1-4" value="0.25" autocomplete="off">
          <label class="btn btn-secondary btn-sm" for="fraccion-${b}-1-4">1/4</label>
          <input type="radio" class="btn-check" name="fraccion-${b}" id="fraccion-${b}-1-2" value="0.5" autocomplete="off">
          <label class="btn btn-secondary btn-sm" for="fraccion-${b}-1-2">1/2</label>
          <input type="radio" class="btn-check" name="fraccion-${b}" id="fraccion-${b}-3-4" value="0.75" autocomplete="off">
          <label class="btn btn-secondary btn-sm" for="fraccion-${b}-3-4">3/4</label>
        </div>
        <span class="btn btn-sm btn-link text-danger p-0 ms-2 deseleccionar-fraccion" data-bebida="${b}" style="cursor: pointer;">
          <i class="fas fa-times-circle"></i>
        </span>
      `;
      tbody.innerHTML += `<tr class="bebida-adulto">
        <td>${b}</td>
        <td>
          <div class="d-flex justify-content-center align-items-center gap-2">
            ${inputCantidad}
            ${radioFracciones}
          </div>
        </td>
      </tr>`;
    });
  }

  tbody.addEventListener('click', (e) => {
    if (e.target.closest('.deseleccionar-fraccion')) {
      const botonDeseleccionar = e.target.closest('.deseleccionar-fraccion');
      const bebida = botonDeseleccionar.dataset.bebida;
      const fraccionSeleccionada = document.querySelector(`input[name="fraccion-${bebida}"]:checked`);
      if (fraccionSeleccionada) {
        fraccionSeleccionada.checked = false;
      }
    }
  });

  document.getElementById("formConsumo").addEventListener("submit", async e => {
    e.preventDefault();

    // Deshabilitar el botón para evitar envíos duplicados
    submitBtn.disabled = true;
    submitBtn.textContent = "Registrando...";

    if (!db || !userId) {
      mostrarAlerta("La aplicación no está lista o el usuario no está autenticado. Intente de nuevo.", "warning");
      submitBtn.disabled = false;
      submitBtn.textContent = "Registrar";
      return;
    }

    const fecha = document.getElementById("fecha").value;
    const evento = document.getElementById("evento").value;
    const usuario = document.getElementById("usuario").value;

    const filas = tbody.querySelectorAll("tr:not(.seccion-separador)");
    let registros = [];
    const movimientosCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/movimientos`);

    const stockActual = await obtenerStockActual();

    for (const fila of filas) {
      const inputEntero = fila.querySelector(".cantidad-entero");
      if (!inputEntero) continue; // Salta las filas que no tienen input (como los separadores)

      const bebida = inputEntero.dataset.bebida;
      const radioSeleccionado = fila.querySelector('input[name="fraccion-' + bebida + '"]:checked');

      // Calcular la cantidad final (Stock Final)
      const cantidadEntera = parseFloat(inputEntero.value) || 0;
      const cantidadFraccion = radioSeleccionado ? parseFloat(radioSeleccionado.value) : 0;
      const cantidadFinal = cantidadEntera + cantidadFraccion; // Esto es el Stock Final ingresado

      // **********************************************
      // LÓGICA CORREGIDA PARA REGISTRAR CONSUMO
      // **********************************************
      if (bebidasSalon.includes(bebida) || bebidasAdulto.includes(bebida)) {
          
          const stockInicialBebida = stockActual[bebida] || 0;
          // Calcular el consumo: Stock Inicial - Stock Final
          const consumoCalculado = stockInicialBebida - cantidadFinal;

          if (consumoCalculado < 0) {
              // Si el consumo calculado es negativo, el stock final ingresado es mayor que el inicial.
              mostrarAlerta(`Error: El stock final de ${bebida} (${cantidadFinal}) es mayor que el stock inicial (${stockInicialBebida}). No se registrará el consumo.`, "danger");
              submitBtn.disabled = false;
              submitBtn.textContent = "Registrar";
              return; // Detener el envío de todo el formulario
          }

          // Solo registramos un movimiento si realmente hubo consumo (consumoCalculado > 0)
          if (consumoCalculado > 0) {
              registros.push({
                  tipo: "consumo",
                  fecha,
                  bebida,
                  cantidad: consumoCalculado,
                  evento,
                  usuario,
                  timestamp: serverTimestamp()
              });
          }
      }
    } // Fin del bucle for

    if (registros.length === 0) {
      mostrarAlerta("No se registraron consumos (stock final = stock inicial para todas las bebidas).", "warning");
      submitBtn.disabled = false;
      submitBtn.textContent = "Registrar";
      return;
    }

    try {
      // Registrar todos los movimientos de consumo
      await Promise.all(registros.map(dato => addDoc(movimientosCollectionRef, dato)));

      mostrarAlerta("¡Registro exitoso!", "success");
      document.getElementById("formConsumo").reset();
      generarFilas();
    } catch (error) {
      console.error("Error al registrar en Firestore:", error);
      mostrarAlerta("Error al registrar: " + error.message, "danger");
    } finally {
      // Habilitar el botón de nuevo
      submitBtn.disabled = false;
      submitBtn.textContent = "Registrar";
    }
  });

  /**
   * Función para obtener el stock actual de todas las bebidas de una sola vez.
   * @returns {Object} Un objeto con el stock de cada bebida.
   */
  async function obtenerStockActual() {
    const movimientosCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/movimientos`);
    // Se podría optimizar esta consulta en Firebase, pero se mantiene la lógica original
    const querySnapshot = await getDocs(query(movimientosCollectionRef));
    
    let stock = {};
    querySnapshot.docs.forEach(doc => {
      const data = doc.data();
      const tipo = data.tipo;
      const bebida = data.bebida;
      const cantidad = parseFloat(data.cantidad);

      if (bebida && !isNaN(cantidad)) {
        if (!stock[bebida]) {
          stock[bebida] = 0;
        }
        if (tipo === "compra") {
          stock[bebida] += cantidad;
        } else if (tipo === "consumo" || tipo === "merma") {
          stock[bebida] -= cantidad;
        }
      }
    });
    return stock;
  }

  document.addEventListener("DOMContentLoaded", () => {
    initFirebase();
    document.getElementById("fecha").valueAsDate = new Date();
  });
</script>
</body>
</html>
