<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Registro de Consumos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light p-4">
  <div class="container bg-white p-4 rounded shadow">
    <h1 class="text-center mb-4">🍷 Registro de Consumos</h1>
    <p class="text-muted text-center" id="currentUserIdDisplay">Cargando ID de usuario...</p>

    <form id="formConsumo">
      <div class="row g-3 mb-3">
        <div class="col-md-4"><label class="form-label">Fecha</label><input type="date" class="form-control" id="fecha" required /></div>
        <div class="col-md-5"><label class="form-label">Evento</label><input type="text" class="form-control" id="evento" /></div>
        <div class="col-md-3"><label class="form-label">Mozo</label><input type="text" class="form-control" id="usuario" /></div>
      </div>

      <div class="table-responsive">
        <table class="table table-bordered text-center align-middle">
          <thead><tr><th>Bebida</th><th>Cantidad</th></tr></thead>
          <tbody id="tablaConsumo"></tbody>
        </table>
      </div>

      <button type="submit" class="btn btn-danger w-100 mt-3">Registrar</button>
      <div id="alerta" class="alert d-none mt-3"></div>
    </form>
  </div>

<script type="module">
  // Importaciones de Firebase SDK
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // Variables globales proporcionadas por el entorno de Canvas (se mantienen por si se usan en otros contextos)
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
  // Configuración de Firebase: Usamos directamente la configuración de tu proyecto
  const firebaseConfig = {
    apiKey: "AIzaSyCfYVuYB0azsjXohRlpt47rvIJWX31YnVg",
    authDomain: "bebidas-f2e09.firebaseapp.com",
    projectId: "bebidas-f2e09",
    storageBucket: "bebidas-f2e09.firebasestorage.app",
    messagingSenderId: "3759804003",
    appId: "1:3759804003:web:a6fc813d925c681c597256",
    measurementId: "G-JZQG7XKRJC"
  };
  const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

  // Inicialización de Firebase
  let app;
  let db;
  let auth;
  let userId = null; // Para almacenar el ID del usuario autenticado

  // Lista de bebidas disponibles
  const bebidas = ["Coca","Coca Zero","Sprite","Sprite Zero","Fanta","Fanta Zero","Agua","Agua Tónica","Soda","Vino Tinto","Vino Blanco","Champagne","Sidra","Cerveza","Cerveza sin Alcohol"];

  // Referencias a elementos del DOM
  const tbody = document.getElementById("tablaConsumo");
  const alerta = document.getElementById("alerta");
  const currentUserIdDisplay = document.getElementById("currentUserIdDisplay"); // Nuevo elemento para mostrar el ID de usuario

  /**
   * Inicializa Firebase y autentica al usuario.
   */
  async function initFirebase() {
    try {
      app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      auth = getAuth(app);

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          userId = user.uid;
          console.log("Usuario autenticado:", userId);
          currentUserIdDisplay.textContent = `ID de Usuario: ${userId}`; // Muestra el ID de usuario
          // Aquí podrías cargar datos específicos del usuario si fuera necesario
        } else {
          // Si no hay usuario, intenta iniciar sesión anónimamente
          try {
            await signInAnonymously(auth); // Intentar autenticación anónima primero
            console.log("Autenticación anónima exitosa.");
          } catch (anonymousError) {
            console.warn("Fallo la autenticación anónima, intentando con token inicial si existe:", anonymousError);
            if (initialAuthToken) {
              try {
                await signInWithCustomToken(auth, initialAuthToken);
                console.log("Autenticación con token inicial exitosa.");
              } catch (tokenError) {
                console.error("Error al autenticar con token inicial:", tokenError);
                mostrarAlerta("Error al autenticar. Intente de nuevo.", "danger");
              }
            } else {
              console.error("Error al autenticar (sin token inicial disponible):", anonymousError);
              mostrarAlerta("Error al autenticar. Intente de nuevo.", "danger");
            }
          }
        }
      });
    } catch (error) {
      console.error("Error al inicializar Firebase:", error);
      mostrarAlerta("Error al inicializar la aplicación. Verifique la configuración.", "danger");
    }
  }

  /**
   * Genera dinámicamente las filas de la tabla de consumo con campos de entrada para cada bebida.
   */
  function generarFilas() {
    tbody.innerHTML = ""; // Limpia el contenido actual de la tabla
    bebidas.forEach(b => {
      tbody.innerHTML += `<tr>
        <td>${b}</td>
        <td><input type="number" class="form-control cantidad" data-bebida="${b}" min="0" value="0" /></td>
      </tr>`;
    });
  }

  // Añade un event listener al formulario para manejar el envío
  document.getElementById("formConsumo").addEventListener("submit", async e => {
    e.preventDefault(); // Previene el envío por defecto del formulario

    if (!db || !userId) {
      mostrarAlerta("La aplicación no está lista. Intente de nuevo en unos segundos.", "warning");
      return;
    }

    // Obtiene los valores de los campos del formulario
    const fecha = document.getElementById("fecha").value;
    const evento = document.getElementById("evento").value;
    const usuario = document.getElementById("usuario").value; // Mozo

    const cantidades = document.querySelectorAll(".cantidad"); // Selecciona todos los campos de cantidad
    let registros = []; // Array para almacenar los registros a enviar

    // Itera sobre los campos de cantidad para recopilar los datos
    cantidades.forEach(input => {
      const cantidad = parseInt(input.value);
      // Solo añade el registro si la cantidad es un número válido y mayor que 0
      if (!isNaN(cantidad) && cantidad > 0) {
        registros.push({
          tipo: "consumo", // Tipo de movimiento fijo para este formulario
          fecha,
          bebida: input.dataset.bebida, // Obtiene el nombre de la bebida del atributo data-bebida
          cantidad,
          evento,
          usuario,
          timestamp: serverTimestamp() // Añade una marca de tiempo del servidor para ordenar
        });
      }
    });

    // Si no se ingresó ninguna bebida, muestra una alerta y detiene la ejecución
    if (registros.length === 0) {
      mostrarAlerta("Debe ingresar al menos una bebida", "warning");
      return;
    }

    try {
      // Referencia a la colección donde se guardarán los movimientos
      // Usamos una colección anidada para datos privados del usuario dentro de la estructura de Canvas
      const movimientosCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/movimientos`);

      // Envía todos los registros a Firestore en paralelo
      await Promise.all(registros.map(dato => addDoc(movimientosCollectionRef, dato)));

      mostrarAlerta("¡Registro exitoso!", "success"); // Muestra mensaje de éxito
      document.getElementById("formConsumo").reset(); // Limpia el formulario
      generarFilas(); // Vuelve a generar las filas de la tabla
    } catch (error) {
      // Captura cualquier error en la escritura a Firestore
      console.error("Error al registrar en Firestore:", error);
      mostrarAlerta("Error al registrar: " + error.message, "danger"); // Muestra mensaje de error
    }
  });

  /**
   * Muestra una alerta temporal en la parte inferior del formulario.
   * @param {string} msg - El mensaje a mostrar.
   * @param {string} tipo - El tipo de alerta (ej. "success", "warning", "danger").
   */
  function mostrarAlerta(msg, tipo) {
    alerta.className = `alert alert-${tipo} mt-3`; // Establece las clases CSS de la alerta
    alerta.textContent = msg; // Establece el texto del mensaje
    alerta.classList.remove("d-none"); // Hace visible la alerta
    // Oculta la alerta después de 4 segundos
    setTimeout(() => alerta.classList.add("d-none"), 4000);
  }

  // Se ejecuta cuando el DOM ha sido completamente cargado
  document.addEventListener("DOMContentLoaded", () => {
    initFirebase(); // Inicializa Firebase al cargar la página
    generarFilas(); // Genera las filas iniciales de la tabla
    // Establece la fecha actual en el campo de fecha
    document.getElementById("fecha").valueAsDate = new Date();
  });
</script>
</body>
</html>
