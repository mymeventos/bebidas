<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Registro de Consumos</title>
  <link rel="icon" href="https://mymeventos.github.io/bebidas/mi-icono.png" type="image/png">
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />
  <style>
    body { background-color: #f0f2f5; padding: 30px; font-family: 'Segoe UI', Tahoma; color: #333; transition: background-color 0.5s ease; }
    .container { background: #fff; padding: 35px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0/0,0.1); }
    .card { border: none; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0/0,0.08); margin-bottom: 30px; }
    .card-header { background-color: #007bff; color: white; font-weight: bold; border-radius: 10px 10px 0 0; padding: 15px 20px; font-size: 1.2rem; }
    .form-label { font-weight: bold; color: #555; }
    .table input.cantidad-entero { width: 90px; text-align: center; }
    .btn-primary:hover, .btn-secondary:hover { transform: translateY(-2px); }
    /* Estilos para la alerta m谩s grande y visible */
    .alert-big { font-size: 1.5rem; padding: 1.5rem; text-align: center; margin-top: 20px; margin-bottom: 20px; }
    /* Clase para el fondo verde de 茅xito */
    .bg-success-flash { background-color: #d4edda !important; }
    .medidas-container { display: flex; justify-content: center; gap: 20px; margin-bottom: 30px; text-align: center; }
    .medida-item { max-width: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; }
    .medida-item img { width: 100%; height: auto; margin-bottom: 5px; }
    /* Nuevos estilos para los botones de fracci贸n */
    .btn-secondary { background-color: #f0f2f5; color: #333; border-color: #e0e0e0; }
    .btn-secondary:hover { background-color: #e9ecef; color: #333; border-color: #ccc; }
    .btn-check:checked + .btn-secondary { background-color: #0d6efd; color: white; border-color: #0d6efd; }
    /* Estilos para los separadores */
    .seccion-separador { background-color: #007bff; color: white; font-weight: bold; text-align: left; padding: 10px; font-size: 1.1em; }
    .barra-separador { background-color: #4a5568; color: #cce0ff; font-weight: bold; text-align: left; padding: 10px; font-size: 1.1em; }
  </style>
</head>
<body>
<div id="appContent" style="display: none;">
  <div class="container bg-white p-4 rounded shadow">
    <h1 class="text-center mb-4"> Registro de Consumos</h1>
    <p class="text-muted text-center" id="currentUserIdDisplay">Cargando ID de usuario...</p>
    <div class="text-center mb-3">
      <button id="logoutBtn" class="btn btn-outline-danger btn-sm"><i class="fas fa-sign-out-alt"></i> Cerrar Sesi贸n</button>
    </div>

    <div class="medidas-container">
      <div class="medida-item">
        <img src="https://mymeventos.github.io/bebidas/full-bottle.png" alt="Botella llena (1)">
        <strong>1</strong>
      </div>
      <div class="medida-item">
        <img src="https://mymeventos.github.io/bebidas/3-4-bottle.png" alt="Botella 3/4 llena">
        <strong>3/4</strong>
      </div>
      <div class="medida-item">
        <img src="https://mymeventos.github.io/bebidas/half-bottle.png" alt="Botella 1/2 llena">
        <strong>1/2</strong>
      </div>
      <div class="medida-item">
        <img src="https://mymeventos.github.io/bebidas/1-4-bottle.png" alt="Botella 1/4 llena">
        <strong>1/4</strong>
      </div>
    </div>

    <form id="formConsumo">
      <div class="row g-3 mb-3">
        <div class="col-md-3"><label class="form-label">Fecha</label><input type="date" class="form-control" id="fecha" required /></div>
        <div class="col-md-3"><label class="form-label">Evento</label><input type="text" class="form-control" id="evento" /></div>
        <div class="col-md-3"><label class="form-label">Encargado</label><input type="text" class="form-control" id="usuario" /></div>
        <div class="col-md-3"><label class="form-label">Costo ($)</label><input type="number" class="form-control" id="precioBase" min="0" placeholder="Opcional" /></div>
      </div>
      <div class="mb-4 text-center">
          <label class="form-label d-block">Modo de Ingreso:</label>
          <div class="btn-group" role="group">
              <input type="radio" class="btn-check" name="inputMode" id="modeStock" autocomplete="off" checked>
              <label class="btn btn-outline-primary" for="modeStock">Stock Final</label>

              <input type="radio" class="btn-check" name="inputMode" id="modeConsumo" autocomplete="off">
              <label class="btn btn-outline-primary" for="modeConsumo">Consumo Directo</label>
          </div>
      </div>
      <div class="table-responsive">
        <table class="table table-bordered text-center align-middle">
          <thead>
              <tr>
                  <th>Bebida</th>
                  <th><span id="cantidadHeader">Cantidad (Stock Final)</span></th>
              </tr>
          </thead>
          <tbody id="tablaConsumo"></tbody>
        </table>
      </div>

      <div id="alerta" class="alert d-none alert-big"></div>

      <button type="submit" class="btn btn-danger w-100 mt-3" id="submitBtn">Registrar</button>
    </form>
  </div>
</div>

<div id="authContainer">
  <h2 class="text-center mb-4">Iniciar Sesi贸n / Registrarse</h2>
  <div class="mb-3">
    <label for="emailInput" class="form-label">Email</label>
    <input type="email" class="form-control" id="emailInput" placeholder="tu@email.com" required>
  </div>
  <div class="mb-3">
    <label for="passwordInput" class="form-label">Contrase帽a</label>
    <input type="password" class="form-control" id="passwordInput" placeholder="********" required>
  </div>
  <div class="d-grid gap-2">
    <button id="signInBtn" class="btn btn-primary">Iniciar Sesi贸n</button>
    <button id="signUpBtn" class="btn btn-secondary">Registrarse</button>
  </div>
  <div id="authAlerta" class="alert d-none mt-3"></div>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>
<script type="module">
  // Importaciones de Firebase SDK (SE AADEN 'where', 'orderBy', 'limit')
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, serverTimestamp, getDocs, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // Variables y Configuraci贸n de Firebase
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
  const firebaseConfig = {
    apiKey: "AIzaSyCfYVuYB0azsjXohRlpt47rvIJWX31YnVg",
    authDomain: "bebidas-f2e09.firebaseapp.com",
    projectId: "bebidas-f2e09",
    storageBucket: "bebidas-f2e09.firebasestorage.app",
    messagingSenderId: "3759804003",
    appId: "1:3759804003:web:a6fc813d925c681c597256",
    measurementId: "G-JZQG7XKRJC"
  };
  
  let app;
  let db;
  let auth;
  let userId = null;
  let currentMode = 'stock'; 

  // Listas de bebidas (se mantienen igual)
  const bebidasSalon = ["Coca","Coca Zero","Sprite","Sprite Zero","Fanta","Fanta Zero","Agua","Agua T贸nica","Soda", "Jugo de naranja", "Pulpa de frutilla", "Pulpa de melon", "Vino Tinto","Vino Blanco","Champagne","Sidra","Cerveza","Cerveza sin Alcohol","Rutini","Trumpeter","Nicasia","Nicasia Viognier","Tardio","Sidra sin alcohol","Anana fizz", "pulpa arandano", "pulpa frambuesa", "pulpa durazno", "alambrado malbec", "santa julia cuve"];
  const bebidasAdulto = ["Gancia","Ron","Ron especial","Carpano rosso","Campari","Vodka","Aperol","Pi帽a colada","Licor de Frutilla","Licor de chocolate","Licor de menta","Blue Curacao","Gin","Fernet", "Whisky","Minerva"];
  const bebidas = [...bebidasSalon, ...bebidasAdulto];
  

  // Referencias a elementos del DOM
  const appContent = document.getElementById("appContent");
  const tbody = document.getElementById("tablaConsumo");
  const alerta = document.getElementById("alerta");
  const currentUserIdDisplay = document.getElementById("currentUserIdDisplay"); 
  const logoutBtn = document.getElementById("logoutBtn");
  const submitBtn = document.getElementById("submitBtn"); 
  const cantidadHeader = document.getElementById("cantidadHeader");
  const modeStock = document.getElementById("modeStock");
  const modeConsumo = document.getElementById("modeConsumo");

  const authContainer = document.getElementById("authContainer");
  const emailInput = document.getElementById("emailInput");
  const passwordInput = document.getElementById("passwordInput");
  const signInBtn = document.getElementById("signInBtn");
  const signUpBtn = document.getElementById("signUpBtn");
  const authAlerta = document.getElementById("authAlerta");


  /**
   * Muestra una alerta temporal.
   */
  function mostrarAlerta(msg, tipo, targetAlerta = alerta) {
    targetAlerta.textContent = msg;
    targetAlerta.className = `alert alert-${tipo} alert-big`; 
    targetAlerta.classList.remove("d-none");
    
    if (tipo === "success") {
      document.body.classList.add("bg-success-flash");
    }

    setTimeout(() => {
      targetAlerta.classList.add("d-none");
      document.body.classList.remove("bg-success-flash");
    }, 4000);
  }

  // Se mantienen las funciones initFirebase, signUpBtn, signInBtn, logoutBtn, generarFilas

  /**
   * Inicializa Firebase y configura el listener de autenticaci贸n.
   */
  async function initFirebase() {
    try {
      app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      auth = getAuth(app);

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          userId = user.uid;
          console.log("Usuario autenticado:", userId);
          currentUserIdDisplay.textContent = `ID de Usuario: ${userId}`;
          appContent.style.display = 'block';
          authContainer.style.display = 'none';
          generarFilas();
        } else {
          userId = null;
          console.log("No hay usuario autenticado.");
          currentUserIdDisplay.textContent = `ID de Usuario: No autenticado`;
          appContent.style.display = 'none';
          authContainer.style.display = 'block';
        }
      });
    } catch (error) {
      console.error("Error al inicializar Firebase:", error);
      mostrarAlerta("Error al inicializar la aplicaci贸n. Verifique la configuraci贸n.", "danger", authAlerta);
    }
  }

  // LISTENERS DE MODO: Actualizan la variable de modo y refrescan la cabecera
  modeStock.addEventListener('change', () => {
      currentMode = 'stock';
      generarFilas();
  });
  modeConsumo.addEventListener('change', () => {
      currentMode = 'consumo';
      generarFilas();
  });

  // Funciones de Autenticaci贸n
  signUpBtn.addEventListener('click', async () => { /* ... */ });
  signInBtn.addEventListener('click', async () => { /* ... */ });
  logoutBtn.addEventListener('click', async () => { /* ... */ });
  
  // Funci贸n para generar filas (se mantiene igual)
  function generarFilas() {
    if (currentMode === 'stock') {
        cantidadHeader.textContent = "Cantidad (Stock Final)";
    } else {
        cantidadHeader.textContent = "Cantidad (Consumo Directo)";
    }
    tbody.innerHTML = "";
    // C贸digo para generar filas (omito por brevedad, se mantiene igual)
    
    tbody.innerHTML += `<tr><td colspan="2" class="seccion-separador">Secci贸n Sal贸n</td></tr>`;
    bebidasSalon.forEach(b => {
      const inputCantidad = `<input type="number" class="form-control cantidad-entero" data-bebida="${b}" min="0" value="0" style="width: 90px; display: inline-block;">`;
      const radioFracciones = `
        <div class="btn-group" role="group" aria-label="Fracciones">
          <input type="radio" class="btn-check" name="fraccion-${b}" id="fraccion-${b}-1-4" value="0.25" autocomplete="off">
          <label class="btn btn-secondary btn-sm" for="fraccion-${b}-1-4">1/4</label>
          <input type="radio" class="btn-check" name="fraccion-${b}" id="fraccion-${b}-1-2" value="0.5" autocomplete="off">
          <label class="btn btn-secondary btn-sm" for="fraccion-${b}-1-2">1/2</label>
          <input type="radio" class="btn-check" name="fraccion-${b}" id="fraccion-${b}-3-4" value="0.75" autocomplete="off">
          <label class="btn btn-secondary btn-sm" for="fraccion-${b}-3-4">3/4</label>
        </div>
        <span class="btn btn-sm btn-link text-danger p-0 ms-2 deseleccionar-fraccion" data-bebida="${b}" style="cursor: pointer;">
          <i class="fas fa-times-circle"></i>
        </span>
      `;
      tbody.innerHTML += `<tr>
        <td>${b}</td>
        <td>
          <div class="d-flex justify-content-center align-items-center gap-2">
            ${inputCantidad}
            ${radioFracciones}
          </div>
        </td>
      </tr>`;
    });

    tbody.innerHTML += `<tr><td colspan="2" class="barra-separador">Secci贸n Barra</td></tr>`;
    bebidasAdulto.forEach(b => {
      const inputCantidad = `<input type="number" class="form-control cantidad-entero" data-bebida="${b}" min="0" value="0" style="width: 90px; display: inline-block;">`;
      const radioFracciones = `
        <div class="btn-group" role="group" aria-label="Fracciones">
          <input type="radio" class="btn-check" name="fraccion-${b}" id="fraccion-${b}-1-4" value="0.25" autocomplete="off">
          <label class="btn btn-secondary btn-sm" for="fraccion-${b}-1-4">1/4</label>
          <input type="radio" class="btn-check" name="fraccion-${b}" id="fraccion-${b}-1-2" value="0.5" autocomplete="off">
          <label class="btn btn-secondary btn-sm" for="fraccion-${b}-1-2">1/2</label>
          <input type="radio" class="btn-check" name="fraccion-${b}" id="fraccion-${b}-3-4" value="0.75" autocomplete="off">
          <label class="btn btn-secondary btn-sm" for="fraccion-${b}-3-4">3/4</label>
        </div>
        <span class="btn btn-sm btn-link text-danger p-0 ms-2 deseleccionar-fraccion" data-bebida="${b}" style="cursor: pointer;">
          <i class="fas fa-times-circle"></i>
        </span>
      `;
      tbody.innerHTML += `<tr class="bebida-adulto">
        <td>${b}</td>
        <td>
          <div class="d-flex justify-content-center align-items-center gap-2">
            ${inputCantidad}
            ${radioFracciones}
          </div>
        </td>
      </tr>`;
    });
  }

  tbody.addEventListener('click', (e) => {
    if (e.target.closest('.deseleccionar-fraccion')) {
      const botonDeseleccionar = e.target.closest('.deseleccionar-fraccion');
      const bebida = botonDeseleccionar.dataset.bebida;
      const fraccionSeleccionada = document.querySelector(`input[name="fraccion-${bebida}"]:checked`);
      if (fraccionSeleccionada) {
        fraccionSeleccionada.checked = false;
      }
    }
  });

  /**
   * NUEVA FUNCIN: Busca el 煤ltimo precio de compra registrado para una bebida espec铆fica.
   */
  async function obtenerUltimoPrecio(bebida) {
    if (!db || !userId) return 0;

    const movimientosCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/movimientos`);

    const q = query(
        movimientosCollectionRef,
        where("tipo", "==", "compra"),
        where("bebida", "==", bebida),
        orderBy("timestamp", "desc"), 
        limit(1)
    );

    const querySnapshot = await getDocs(q);

    if (!querySnapshot.empty) {
        const data = querySnapshot.docs[0].data();
        // Devuelve el precio si existe en el documento de compra
        return parseFloat(data.precio) || 0; 
    }

    return 0; // Si no se encuentra ning煤n precio de compra
  }


  document.getElementById("formConsumo").addEventListener("submit", async e => {
    e.preventDefault();

    submitBtn.disabled = true;
    submitBtn.textContent = "Registrando...";

    if (!db || !userId) {
      mostrarAlerta("La aplicaci贸n no est谩 lista o el usuario no est谩 autenticado. Intente de nuevo.", "warning");
      submitBtn.disabled = false;
      submitBtn.textContent = "Registrar";
      return;
    }

    const fecha = document.getElementById("fecha").value;
    const evento = document.getElementById("evento").value;
    const usuario = document.getElementById("usuario").value;
    
    // Obtener el precio base ingresado, 0 si est谩 vac铆o
    const precioBaseInput = document.getElementById("precioBase").value;
    const precioBase = parseFloat(precioBaseInput) || 0; 

    const filas = tbody.querySelectorAll("tr:not(.seccion-separador)");
    let registros = [];
    const movimientosCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/movimientos`);

    const stockActual = currentMode === 'stock' ? await obtenerStockActual() : {};

    for (const fila of filas) {
      const inputEntero = fila.querySelector(".cantidad-entero");
      if (!inputEntero) continue; 

      const bebida = inputEntero.dataset.bebida;
      const radioSeleccionado = fila.querySelector('input[name="fraccion-' + bebida + '"]:checked');

      const cantidadEntera = parseFloat(inputEntero.value) || 0;
      const cantidadFraccion = radioSeleccionado ? parseFloat(radioSeleccionado.value) : 0;
      const cantidadTotalIngresada = cantidadEntera + cantidadFraccion; 

      if (bebidasSalon.includes(bebida) || bebidasAdulto.includes(bebida)) {
          
          let cantidadARegistrar = 0;

          if (currentMode === 'stock') {
              const stockInicialBebida = stockActual[bebida] || 0;
              cantidadARegistrar = stockInicialBebida - cantidadTotalIngresada; 

              if (cantidadARegistrar < 0) {
                  mostrarAlerta(`Error: El stock final de ${bebida} (${cantidadTotalIngresada}) es mayor que el stock inicial (${stockInicialBebida}). No se registrar谩 el consumo.`, "danger");
                  submitBtn.disabled = false;
                  submitBtn.textContent = "Registrar";
                  return; 
              }

          } else {
              cantidadARegistrar = cantidadTotalIngresada;
          }


          if (cantidadARegistrar > 0) {
              
              let precioUnitario = precioBase; // Usamos el precio ingresado en el campo "Costo ($)"

              // Si el usuario NO ingres贸 un precio (es 0), buscamos el 煤ltimo de la BD
              if (precioBase === 0) {
                  precioUnitario = await obtenerUltimoPrecio(bebida); 
                  if (precioUnitario === 0) {
                      console.warn(`Advertencia: No se encontr贸 precio de compra para ${bebida}. Se registrar谩 con precio 0.`);
                  }
              }

              registros.push({
                  tipo: "consumo",
                  fecha,
                  bebida,
                  cantidad: cantidadARegistrar,
                  evento,
                  usuario,
                  precio: precioUnitario, // <-- AADIMOS EL PRECIO DETERMINADO
                  timestamp: serverTimestamp()
              });
          }
      }
    } 

    if (registros.length === 0) {
      mostrarAlerta("No se registraron movimientos. La cantidad ingresada fue cero para todas las bebidas.", "warning");
      submitBtn.disabled = false;
      submitBtn.textContent = "Registrar";
      return;
    }

    try {
      await Promise.all(registros.map(dato => addDoc(movimientosCollectionRef, dato)));

      mostrarAlerta("隆Registro exitoso!", "success");
      document.getElementById("formConsumo").reset();
      generarFilas(); 
    } catch (error) {
      console.error("Error al registrar en Firestore:", error);
      mostrarAlerta("Error al registrar: " + error.message, "danger");
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = "Registrar";
    }
  });

  /**
   * Funci贸n para obtener el stock actual de todas las bebidas de una sola vez. (Se mantiene igual)
   */
  async function obtenerStockActual() {
    const movimientosCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/movimientos`);
    const querySnapshot = await getDocs(query(movimientosCollectionRef));
    
    let stock = {};
    querySnapshot.docs.forEach(doc => {
      const data = doc.data();
      const tipo = data.tipo;
      const bebida = data.bebida;
      const cantidad = parseFloat(data.cantidad);

      if (bebida && !isNaN(cantidad)) {
        if (!stock[bebida]) {
          stock[bebida] = 0;
        }
        if (tipo === "compra") {
          stock[bebida] += cantidad;
        } else if (tipo === "consumo" || tipo === "merma") {
          stock[bebida] -= cantidad;
        }
      }
    });
    return stock;
  }

  document.addEventListener("DOMContentLoaded", () => {
    initFirebase();
    document.getElementById("fecha").valueAsDate = new Date();
  });
</script>
</body>
</html>
